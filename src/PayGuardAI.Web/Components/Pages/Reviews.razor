@page "/reviews"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IReviewService ReviewService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject PayGuardAI.Web.Services.CurrentUserService CurrentUser
@inject ITenantContext TenantContext
@inject IJSRuntime JS
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using PayGuardAI.Core.Entities
@using PayGuardAI.Web.Hubs

<PageTitle>Pending Reviews - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.RateReview" Class="mr-2" />
    Pending Reviews
</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4 d-none d-md-flex">
    <MudText>
        <strong>HITL Workflow:</strong> Transactions flagged by the AI require human review before processing. 
        Review each transaction's risk factors and make an informed decision.
    </MudText>
</MudAlert>

<!-- Mobile swipe hint (shown once) -->
<MudAlert Severity="Severity.Info" Class="mb-3 d-flex d-md-none" Dense="true" Icon="@Icons.Material.Filled.SwipeRight">
    <MudText Typo="Typo.caption">Swipe right to approve, left to reject</MudText>
</MudAlert>

<!-- Approve Dialog using MudOverlay -->
<MudOverlay Visible="_showApproveDialog" DarkBackground="false" AutoClose="false" Style="background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <MudPaper Class="pa-6" Style="max-width: 380px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" Color="Color.Success" />
                Approve Transaction
            </MudText>
            @if (_selectedReview != null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    ID: <strong>@_selectedReview.Transaction.ExternalId</strong>
                </MudText>
                <MudDivider Class="my-2" />
                <MudTextField @bind-Value="_reviewNotes" Label="Approval Notes" Required="true"
                              Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense"
                              Placeholder="Explain why you are approving this transaction..." Class="mb-3"
                              RequiredError="Approval notes are required for compliance" />
            }
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                <MudButton OnClick="@(() => _showApproveDialog = false)" Class="mobile-action-btn">Cancel</MudButton>
                <MudButton Color="Color.Success" Variant="Variant.Filled" Class="mobile-action-btn" OnClick="@ApproveReview"
                           Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Approve</MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudOverlay>

<!-- Reject Dialog using MudOverlay -->
<MudOverlay Visible="_showRejectDialog" DarkBackground="false" AutoClose="false" Style="background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <MudPaper Class="pa-6" Style="max-width: 380px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" Color="Color.Error" />
                Reject Transaction
            </MudText>
            @if (_selectedReview != null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    ID: <strong>@_selectedReview.Transaction.ExternalId</strong>
                </MudText>
                <MudDivider Class="my-2" />
                <MudTextField @bind-Value="_reviewNotes" Label="Rejection Reason" Required="true"
                              Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense"
                              Placeholder="Explain why this transaction is being rejected..." Class="mb-3"
                              RequiredError="A rejection reason is required for compliance" />
            }
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                <MudButton OnClick="@(() => _showRejectDialog = false)" Class="mobile-action-btn">Cancel</MudButton>
                <MudButton Color="Color.Error" Variant="Variant.Filled" Class="mobile-action-btn" OnClick="@RejectReview"
                           Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Reject</MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudOverlay>

<MudPaper Class="pa-4 pa-sm-4" Elevation="2" id="reviews-container">
    <!-- Pull-to-refresh indicator -->
    <div class="pull-indicator">
        <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" />
        <MudText Typo="Typo.caption" Class="ml-2">Pull to refresh</MudText>
    </div>

    <MudGrid Spacing="2" Class="mb-3">
        <!-- Min Risk Level Filter -->
        <MudItem xs="6" sm="6" md="4">
            <MudSelect T="RiskLevel?" Label="Min Risk Level" Value="@_minRiskLevel" 
                       ValueChanged="@OnFilterChanged" Dense="true" FullWidth="true">
                <MudSelectItem T="RiskLevel?" Value="@((RiskLevel?)null)">All</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.Medium">Medium+</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.High">High+</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.Critical">Critical Only</MudSelectItem>
            </MudSelect>
        </MudItem>

        <!-- Reviews Count -->
        <MudItem xs="6" sm="6" md="4" Class="d-flex align-center">
            <MudChip T="string" Color="Color.Warning" Size="Size.Medium">@_reviews.Count Pending</MudChip>
        </MudItem>

        <!-- Per Page Filter (hidden on mobile - uses infinite scroll feel) -->
        <MudItem xs="6" sm="6" md="2" Class="d-none d-md-flex">
            <MudSelect T="int" Value="_pageSize" ValueChanged="OnPageSizeChanged" Label="Per page" Dense="true" FullWidth="true">
                <MudSelectItem T="int" Value="5">5</MudSelectItem>
                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                <MudSelectItem T="int" Value="25">25</MudSelectItem>
            </MudSelect>
        </MudItem>

        <!-- Refresh Button -->
        <MudItem xs="6" sm="6" md="2" Class="d-flex align-center">
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="@LoadReviews" FullWidth="true" Class="mobile-action-btn">Refresh</MudButton>
        </MudItem>
    </MudGrid>

    <!-- Page Info Display -->
    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
        Showing @(Math.Min((_currentPage - 1) * _pageSize + 1, _reviews.Count))–@(Math.Min(_currentPage * _pageSize, _reviews.Count)) of @_reviews.Count
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (!_reviews.Any())
    {
        <MudAlert Severity="Severity.Success" Class="mt-4">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
            No pending reviews! All caught up.
        </MudAlert>
    }
    else
    {
        @foreach (var review in PagedReviews)
        {
            var cardId = $"review-card-{review.Id}";
            <!-- Desktop layout -->
            <MudCard Class="mb-3 d-none d-md-block" Elevation="1">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="3">
                            <MudStack>
                                <MudText Typo="Typo.caption">Transaction ID</MudText>
                                <MudText>@(review.Transaction.ExternalId.Length > 16 ? review.Transaction.ExternalId[..16] + "..." : review.Transaction.ExternalId)</MudText>
                                <MudText Typo="Typo.caption" Class="mt-2">Amount</MudText>
                                <MudText Typo="Typo.h6">@review.Transaction.Amount.ToString("N2") @review.Transaction.SourceCurrency</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudStack AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption">Risk Score</MudText>
                                <MudProgressCircular Color="@GetRiskColor(review.RiskLevel)" 
                                                     Size="Size.Medium" Value="@review.RiskScore">
                                    <MudText Typo="Typo.body2">@review.RiskScore</MudText>
                                </MudProgressCircular>
                                <MudChip T="string" Color="@GetRiskColor(review.RiskLevel)" Size="Size.Small" Style="@GetRiskStyle(review.RiskLevel)">
                                    @review.RiskLevel
                                </MudChip>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.caption">Risk Summary</MudText>
                            <MudText Typo="Typo.body2" Style="max-height: 60px; overflow: hidden;">
                                @review.Explanation
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mt-2">
                                @review.RiskFactors.Count risk factor(s) detected
                            </MudText>
                            @if (review.ReviewStatus == ReviewStatus.Escalated)
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2" NoIcon="true">
                                    <MudText Typo="Typo.caption"><strong>Escalated by:</strong> @review.ReviewedBy</MudText>
                                    <MudText Typo="Typo.caption">@review.ReviewedAt?.ToString("MMM dd, HH:mm")</MudText>
                                </MudAlert>
                            }
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudStack>
                                <MudButton Variant="Variant.Filled" Color="Color.Success" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.CheckCircle"
                                           OnClick="@(() => OpenApproveDialog(review))"
                                           Disabled="@_processing">
                                    Approve
                                </MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Error" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Cancel"
                                           OnClick="@(() => OpenRejectDialog(review))"
                                           Disabled="@_processing">
                                    Reject
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Visibility"
                                           Href="@($"/transactions/{review.TransactionId}?returnTo=/reviews")">
                                    View Details
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- Mobile layout (swipe-friendly compact card) -->
            <MudCard Class="mb-3 d-block d-md-none review-card-mobile" Elevation="1" id="@cardId">
                <MudCardContent Style="padding: 12px;">
                    <!-- Top row: Amount + Risk Score -->
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h6" Style="font-size: 1.1rem;">
                                @review.Transaction.Amount.ToString("N2") @review.Transaction.SourceCurrency
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @review.Transaction.SourceCountry → @review.Transaction.DestinationCountry
                            </MudText>
                        </MudStack>
                        <MudStack AlignItems="AlignItems.Center" Spacing="0">
                            <MudProgressCircular Color="@GetRiskColor(review.RiskLevel)" 
                                                 Size="Size.Small" Value="@review.RiskScore">
                                <MudText Typo="Typo.caption" Style="font-size: 0.65rem;">@review.RiskScore</MudText>
                            </MudProgressCircular>
                            <MudChip T="string" Color="@GetRiskColor(review.RiskLevel)" Size="Size.Small" 
                                     Style="@(GetRiskStyle(review.RiskLevel) + "font-size:0.7rem; height:22px;")">
                                @review.RiskLevel
                            </MudChip>
                        </MudStack>
                    </MudStack>

                    <!-- Risk summary (truncated on mobile) -->
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2" 
                             Style="font-size: 0.8rem; max-height: 36px; overflow: hidden; text-overflow: ellipsis;">
                        @review.Explanation
                    </MudText>

                    @if (review.ReviewStatus == ReviewStatus.Escalated)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mt-1" Style="font-size:0.7rem;">
                            Escalated by @review.ReviewedBy
                        </MudChip>
                    }

                    <!-- Mobile action buttons (large touch targets) -->
                    <div class="review-actions-mobile mt-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Success" 
                                   StartIcon="@Icons.Material.Filled.Check"
                                   OnClick="@(() => OpenApproveDialog(review))"
                                   Disabled="@_processing"
                                   Class="mobile-action-btn" Style="flex:1;">
                            Approve
                        </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Error" 
                                   StartIcon="@Icons.Material.Filled.Close"
                                   OnClick="@(() => OpenRejectDialog(review))"
                                   Disabled="@_processing"
                                   Class="mobile-action-btn" Style="flex:1;">
                            Reject
                        </MudButton>
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary"
                                       Href="@($"/transactions/{review.TransactionId}?returnTo=/reviews")"
                                       Class="mobile-action-btn" />
                    </div>
                </MudCardContent>
            </MudCard>
        }

        @if (TotalPages > 1)
        {
            <MudStack Row="true" Justify="Justify.Center" Class="mt-3">
                <MudPagination Count="@TotalPages" Selected="@_currentPage" 
                               SelectedChanged="OnPageChanged"
                               BoundaryCount="1" MiddleCount="3" ShowFirstButton="true" ShowLastButton="true" />
            </MudStack>
        }
    }
</MudPaper>

@code {
    private bool _loading = true;
    private bool _processing = false;
    private List<RiskAnalysis> _reviews = new();
    private RiskLevel? _minRiskLevel;
    private RiskAnalysis? _selectedReview;
    private string _reviewNotes = "";
    private bool _showApproveDialog = false;
    private bool _showRejectDialog = false;
    private HubConnection? _hubConnection;
    private Dictionary<Guid, DotNetObjectReference<SwipeHandler>> _swipeRefs = new();

    [CascadingParameter(Name = "OnReviewCompleted")]
    private Func<Task>? OnReviewCompleted { get; set; }

    // Pagination - smaller page size since review cards are larger than table rows
    private int _currentPage = 1;
    private int _pageSize = 5;
    private int TotalPages => (int)Math.Ceiling(_reviews.Count / (double)_pageSize);
    private IEnumerable<RiskAnalysis> PagedReviews => _reviews
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize);

    private void OnPageChanged(int page) => _currentPage = page;
    private void OnPageSizeChanged(int size) { _pageSize = size; _currentPage = 1; }

    protected override async Task OnInitializedAsync()
    {
        await LoadReviews();
        await SetupSignalRConnection();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        // Initialize pull-to-refresh
        try
        {
            var dotNetRef = DotNetObjectReference.Create(new PullRefreshHandler(this));
            await JS.InvokeVoidAsync("PayGuardMobile.initPullToRefresh", "reviews-container", dotNetRef);
        }
        catch { /* JS interop not available during prerender */ }
        
        // Initialize swipe on mobile cards
        await InitSwipeHandlers();
    }

    private async Task InitSwipeHandlers()
    {
        foreach (var review in PagedReviews)
        {
            try
            {
                var handler = new SwipeHandler(this, review);
                var dotNetRef = DotNetObjectReference.Create(handler);
                _swipeRefs[review.Id] = dotNetRef;
                await JS.InvokeVoidAsync("PayGuardMobile.initSwipe", $"review-card-{review.Id}", dotNetRef);
            }
            catch { /* Prerender or SSR */ }
        }
    }

    // Swipe handler class for JS interop callbacks
    public class SwipeHandler
    {
        private readonly Reviews _parent;
        private readonly RiskAnalysis _review;
        
        public SwipeHandler(Reviews parent, RiskAnalysis review)
        {
            _parent = parent;
            _review = review;
        }
        
        [JSInvokable]
        public async Task OnSwipeRight()
        {
            // Swipe right = Approve
            await _parent.InvokeAsync(() =>
            {
                _parent.OpenApproveDialog(_review);
                _parent.StateHasChanged();
            });
        }
        
        [JSInvokable]
        public async Task OnSwipeLeft()
        {
            // Swipe left = Reject
            await _parent.InvokeAsync(() =>
            {
                _parent.OpenRejectDialog(_review);
                _parent.StateHasChanged();
            });
        }
    }

    // Pull-to-refresh handler
    public class PullRefreshHandler
    {
        private readonly Reviews _parent;
        public PullRefreshHandler(Reviews parent) => _parent = parent;
        
        [JSInvokable]
        public async Task OnPullRefresh()
        {
            await _parent.InvokeAsync(async () =>
            {
                await _parent.LoadReviews();
                _parent.StateHasChanged();
            });
        }
    }

    private async Task SetupSignalRConnection()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/transactions"))
            .WithAutomaticReconnect()
            .Build();
        
        _hubConnection.On<TransactionNotification>("NewTransaction", async (notification) =>
        {
            // Auto-refresh if a Medium+ risk transaction comes in
            if (notification.RiskLevel >= RiskLevel.Medium)
            {
                await LoadReviews();
                Snackbar.Add($"New {notification.RiskLevel} risk transaction requires review", Severity.Warning);
            }
        });
        
        try
        {
            await _hubConnection.StartAsync();
            var tenantId = TenantContext.TenantId;
            if (!string.IsNullOrEmpty(tenantId))
            {
                await _hubConnection.InvokeAsync("JoinTenantGroup", tenantId);
            }
        }
        catch
        {
            // SignalR will auto-reconnect
        }
    }

    private async Task LoadReviews()
    {
        _loading = true;
        try
        {
            var reviews = await ReviewService.GetPendingReviewsAsync(_minRiskLevel);
            _reviews = reviews.ToList();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnFilterChanged(RiskLevel? value)
    {
        _minRiskLevel = value;
        _currentPage = 1;
        await LoadReviews();
    }

    private void OpenApproveDialog(RiskAnalysis review)
    {
        _selectedReview = review;
        _reviewNotes = "";
        _showApproveDialog = true;
    }

    private void OpenRejectDialog(RiskAnalysis review)
    {
        _selectedReview = review;
        _reviewNotes = "";
        _showRejectDialog = true;
    }

    private async Task ApproveReview()
    {
        if (_selectedReview == null) return;
        
        _processing = true;
        _showApproveDialog = false;
        try
        {
            await ReviewService.ApproveAsync(_selectedReview.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add($"Transaction approved", Severity.Success);
            _reviews.Remove(_selectedReview);
            _reviewNotes = "";
            if (OnReviewCompleted != null) await OnReviewCompleted();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RejectReview()
    {
        if (_selectedReview == null) return;
        
        _processing = true;
        _showRejectDialog = false;
        try
        {
            await ReviewService.RejectAsync(_selectedReview.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add($"Transaction rejected", Severity.Warning);
            _reviews.Remove(_selectedReview);
            _reviewNotes = "";
            if (OnReviewCompleted != null) await OnReviewCompleted();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private Color GetRiskColor(RiskLevel level) => level switch
    {
        RiskLevel.Low => Color.Success,
        RiskLevel.Medium => Color.Warning,
        RiskLevel.High => Color.Error,
        RiskLevel.Critical => Color.Error,
        _ => Color.Default
    };

    private string GetRiskStyle(RiskLevel level) => level switch
    {
        RiskLevel.High => "opacity: 0.8;",
        RiskLevel.Critical => "opacity: 1.0; font-weight: bold;",
        _ => ""
    };

    public async ValueTask DisposeAsync()
    {
        // Clean up swipe handler references
        foreach (var kvp in _swipeRefs)
        {
            kvp.Value.Dispose();
        }
        _swipeRefs.Clear();
        
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
