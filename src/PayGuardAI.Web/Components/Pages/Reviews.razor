@page "/reviews"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IReviewService ReviewService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject PayGuardAI.Web.Services.CurrentUserService CurrentUser
@inject ITenantContext TenantContext
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using PayGuardAI.Core.Entities
@using PayGuardAI.Web.Hubs

<PageTitle>Pending Reviews - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.RateReview" Class="mr-2" />
    Pending Reviews (Human-in-the-Loop)
</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4">
    <MudText>
        <strong>HITL Workflow:</strong> Transactions flagged by the AI require human review before processing. 
        Review each transaction's risk factors and make an informed decision.
    </MudText>
</MudAlert>

<!-- Approve Dialog using MudOverlay -->
<MudOverlay Visible="_showApproveDialog" DarkBackground="false" AutoClose="false" Style="background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <MudPaper Class="pa-6" Style="max-width: 380px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" Color="Color.Success" />
                Approve Transaction
            </MudText>
            @if (_selectedReview != null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    ID: <strong>@_selectedReview.Transaction.ExternalId</strong>
                </MudText>
                <MudDivider Class="my-2" />
                <MudTextField @bind-Value="_reviewNotes" Label="Approval Notes" Required="true"
                              Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense"
                              Placeholder="Explain why you are approving this transaction..." Class="mb-3"
                              RequiredError="Approval notes are required for compliance" />
            }
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                <MudButton OnClick="@(() => _showApproveDialog = false)" Size="Size.Small">Cancel</MudButton>
                <MudButton Color="Color.Success" Variant="Variant.Filled" Size="Size.Small" OnClick="@ApproveReview"
                           Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Approve</MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudOverlay>

<!-- Reject Dialog using MudOverlay -->
<MudOverlay Visible="_showRejectDialog" DarkBackground="false" AutoClose="false" Style="background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <MudPaper Class="pa-6" Style="max-width: 380px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" Color="Color.Error" />
                Reject Transaction
            </MudText>
            @if (_selectedReview != null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    ID: <strong>@_selectedReview.Transaction.ExternalId</strong>
                </MudText>
                <MudDivider Class="my-2" />
                <MudTextField @bind-Value="_reviewNotes" Label="Rejection Reason" Required="true"
                              Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense"
                              Placeholder="Explain why this transaction is being rejected..." Class="mb-3"
                              RequiredError="A rejection reason is required for compliance" />
            }
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                <MudButton OnClick="@(() => _showRejectDialog = false)" Size="Size.Small">Cancel</MudButton>
                <MudButton Color="Color.Error" Variant="Variant.Filled" Size="Size.Small" OnClick="@RejectReview"
                           Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Reject</MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudOverlay>

<MudPaper Class="pa-4" Elevation="2">
    <MudGrid Spacing="2" Class="mb-3">
        <!-- Min Risk Level Filter -->
        <MudItem xs="12" sm="6" md="4">
            <MudSelect T="RiskLevel?" Label="Min Risk Level" Value="@_minRiskLevel" 
                       ValueChanged="@OnFilterChanged" Dense="true" FullWidth="true">
                <MudSelectItem T="RiskLevel?" Value="@((RiskLevel?)null)">All</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.Medium">Medium+</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.High">High+</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.Critical">Critical Only</MudSelectItem>
            </MudSelect>
        </MudItem>

        <!-- Reviews Count -->
        <MudItem xs="12" sm="6" md="4" Class="d-flex align-center">
            <MudChip T="string" Color="Color.Warning" Size="Size.Medium">@_reviews.Count Pending</MudChip>
        </MudItem>

        <!-- Per Page Filter & Refresh -->
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="int" Value="_pageSize" ValueChanged="OnPageSizeChanged" Label="Per page" Dense="true" FullWidth="true">
                <MudSelectItem T="int" Value="5">5</MudSelectItem>
                <MudSelectItem T="int" Value="10">10</MudSelectItem>
                <MudSelectItem T="int" Value="25">25</MudSelectItem>
            </MudSelect>
        </MudItem>

        <!-- Refresh Button -->
        <MudItem xs="12" sm="6" md="2" Class="d-flex align-center">
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="@LoadReviews" FullWidth="true">Refresh</MudButton>
        </MudItem>
    </MudGrid>

    <!-- Page Info Display -->
    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
        Showing @(Math.Min((_currentPage - 1) * _pageSize + 1, _reviews.Count))â€“@(Math.Min(_currentPage * _pageSize, _reviews.Count)) of @_reviews.Count
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (!_reviews.Any())
    {
        <MudAlert Severity="Severity.Success" Class="mt-4">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
            No pending reviews! All caught up.
        </MudAlert>
    }
    else
    {
        @foreach (var review in PagedReviews)
        {
            <MudCard Class="mb-3" Elevation="1">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="3">
                            <MudStack>
                                <MudText Typo="Typo.caption">Transaction ID</MudText>
                                <MudText>@(review.Transaction.ExternalId.Length > 16 ? review.Transaction.ExternalId[..16] + "..." : review.Transaction.ExternalId)</MudText>
                                <MudText Typo="Typo.caption" Class="mt-2">Amount</MudText>
                                <MudText Typo="Typo.h6">@review.Transaction.Amount.ToString("N2") @review.Transaction.SourceCurrency</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudStack AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption">Risk Score</MudText>
                                <MudProgressCircular Color="@GetRiskColor(review.RiskLevel)" 
                                                     Size="Size.Medium" Value="@review.RiskScore">
                                    <MudText Typo="Typo.body2">@review.RiskScore</MudText>
                                </MudProgressCircular>
                                <MudChip T="string" Color="@GetRiskColor(review.RiskLevel)" Size="Size.Small" Style="@GetRiskStyle(review.RiskLevel)">
                                    @review.RiskLevel
                                </MudChip>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.caption">Risk Summary</MudText>
                            <MudText Typo="Typo.body2" Style="max-height: 60px; overflow: hidden;">
                                @review.Explanation
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mt-2">
                                @review.RiskFactors.Count risk factor(s) detected
                            </MudText>
                            @if (review.ReviewStatus == ReviewStatus.Escalated)
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2" NoIcon="true">
                                    <MudText Typo="Typo.caption"><strong>Escalated by:</strong> @review.ReviewedBy</MudText>
                                    <MudText Typo="Typo.caption">@review.ReviewedAt?.ToString("MMM dd, HH:mm")</MudText>
                                </MudAlert>
                            }
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudStack>
                                <MudButton Variant="Variant.Filled" Color="Color.Success" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.CheckCircle"
                                           OnClick="@(() => OpenApproveDialog(review))"
                                           Disabled="@_processing">
                                    Approve
                                </MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Error" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Cancel"
                                           OnClick="@(() => OpenRejectDialog(review))"
                                           Disabled="@_processing">
                                    Reject
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Visibility"
                                           Href="@($"/transactions/{review.TransactionId}?returnTo=/reviews")">
                                    View Details
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        }

        @if (TotalPages > 1)
        {
            <MudStack Row="true" Justify="Justify.Center" Class="mt-3">
                <MudPagination Count="@TotalPages" Selected="@_currentPage" 
                               SelectedChanged="OnPageChanged"
                               BoundaryCount="1" MiddleCount="3" ShowFirstButton="true" ShowLastButton="true" />
            </MudStack>
        }
    }
</MudPaper>

@code {
    private bool _loading = true;
    private bool _processing = false;
    private List<RiskAnalysis> _reviews = new();
    private RiskLevel? _minRiskLevel;
    private RiskAnalysis? _selectedReview;
    private string _reviewNotes = "";
    private bool _showApproveDialog = false;
    private bool _showRejectDialog = false;
    private HubConnection? _hubConnection;

    // Pagination - smaller page size since review cards are larger than table rows
    private int _currentPage = 1;
    private int _pageSize = 5;
    private int TotalPages => (int)Math.Ceiling(_reviews.Count / (double)_pageSize);
    private IEnumerable<RiskAnalysis> PagedReviews => _reviews
        .Skip((_currentPage - 1) * _pageSize)
        .Take(_pageSize);

    private void OnPageChanged(int page) => _currentPage = page;
    private void OnPageSizeChanged(int size) { _pageSize = size; _currentPage = 1; }

    protected override async Task OnInitializedAsync()
    {
        await LoadReviews();
        await SetupSignalRConnection();
    }

    private async Task SetupSignalRConnection()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/transactions"))
            .WithAutomaticReconnect()
            .Build();
        
        _hubConnection.On<TransactionNotification>("NewTransaction", async (notification) =>
        {
            // Auto-refresh if a Medium+ risk transaction comes in
            if (notification.RiskLevel >= RiskLevel.Medium)
            {
                await LoadReviews();
                Snackbar.Add($"New {notification.RiskLevel} risk transaction requires review", Severity.Warning);
            }
        });
        
        try
        {
            await _hubConnection.StartAsync();
            var tenantId = TenantContext.TenantId;
            if (!string.IsNullOrEmpty(tenantId))
            {
                await _hubConnection.InvokeAsync("JoinTenantGroup", tenantId);
            }
        }
        catch
        {
            // SignalR will auto-reconnect
        }
    }

    private async Task LoadReviews()
    {
        _loading = true;
        try
        {
            var reviews = await ReviewService.GetPendingReviewsAsync(_minRiskLevel);
            _reviews = reviews.ToList();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnFilterChanged(RiskLevel? value)
    {
        _minRiskLevel = value;
        _currentPage = 1;
        await LoadReviews();
    }

    private void OpenApproveDialog(RiskAnalysis review)
    {
        _selectedReview = review;
        _reviewNotes = "";
        _showApproveDialog = true;
    }

    private void OpenRejectDialog(RiskAnalysis review)
    {
        _selectedReview = review;
        _reviewNotes = "";
        _showRejectDialog = true;
    }

    private async Task ApproveReview()
    {
        if (_selectedReview == null) return;
        
        _processing = true;
        _showApproveDialog = false;
        try
        {
            await ReviewService.ApproveAsync(_selectedReview.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add($"Transaction approved", Severity.Success);
            _reviews.Remove(_selectedReview);
            _reviewNotes = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RejectReview()
    {
        if (_selectedReview == null) return;
        
        _processing = true;
        _showRejectDialog = false;
        try
        {
            await ReviewService.RejectAsync(_selectedReview.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add($"Transaction rejected", Severity.Warning);
            _reviews.Remove(_selectedReview);
            _reviewNotes = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private Color GetRiskColor(RiskLevel level) => level switch
    {
        RiskLevel.Low => Color.Success,
        RiskLevel.Medium => Color.Warning,
        RiskLevel.High => Color.Error,
        RiskLevel.Critical => Color.Error,
        _ => Color.Default
    };

    private string GetRiskStyle(RiskLevel level) => level switch
    {
        RiskLevel.High => "opacity: 0.8;",
        RiskLevel.Critical => "opacity: 1.0; font-weight: bold;",
        _ => ""
    };

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
