@page "/reviews"
@inject IReviewService ReviewService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject PayGuardAI.Web.Services.CurrentUserService CurrentUser
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using PayGuardAI.Core.Entities
@using PayGuardAI.Web.Hubs

<PageTitle>Pending Reviews - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.RateReview" Class="mr-2" />
    Pending Reviews (Human-in-the-Loop)
</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4">
    <MudText>
        <strong>HITL Workflow:</strong> Transactions flagged by the AI require human review before processing. 
        Review each transaction's risk factors and make an informed decision.
    </MudText>
</MudAlert>

<!-- Approve Dialog using MudOverlay -->
<MudOverlay Visible="_showApproveDialog" DarkBackground="true" AutoClose="false">
    <MudPaper Class="pa-4" Style="min-width: 400px; max-width: 500px;">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" Color="Color.Success" />
            Approve Transaction
        </MudText>
        @if (_selectedReview != null)
        {
            <MudText Class="mb-3">
                You are about to <strong>approve</strong> transaction <strong>@_selectedReview.Transaction.ExternalId</strong>
            </MudText>
            <MudTextField @bind-Value="_reviewNotes" Label="Approval Notes" Required="true"
                          Variant="Variant.Outlined" Lines="3" 
                          Placeholder="Explain why you are approving this transaction..." Class="mb-4"
                          RequiredError="Approval notes are required for compliance" />
        }
        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
            <MudButton OnClick="@(() => _showApproveDialog = false)">Cancel</MudButton>
            <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="@ApproveReview"
                       Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Approve</MudButton>
        </MudStack>
    </MudPaper>
</MudOverlay>

<!-- Reject Dialog using MudOverlay -->
<MudOverlay Visible="_showRejectDialog" DarkBackground="true" AutoClose="false">
    <MudPaper Class="pa-4" Style="min-width: 400px; max-width: 500px;">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" Color="Color.Error" />
            Reject Transaction
        </MudText>
        @if (_selectedReview != null)
        {
            <MudText Class="mb-3">
                You are about to <strong>reject</strong> transaction <strong>@_selectedReview.Transaction.ExternalId</strong>
            </MudText>
            <MudTextField @bind-Value="_reviewNotes" Label="Rejection Reason" Required="true"
                          Variant="Variant.Outlined" Lines="3" 
                          Placeholder="Explain why this transaction is being rejected..." Class="mb-4"
                          RequiredError="A rejection reason is required for compliance" />
        }
        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
            <MudButton OnClick="@(() => _showRejectDialog = false)">Cancel</MudButton>
            <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="@RejectReview"
                       Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Reject</MudButton>
        </MudStack>
    </MudPaper>
</MudOverlay>

<MudPaper Class="pa-4" Elevation="2">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
        <MudStack Row="true" Spacing="3">
            <MudSelect T="RiskLevel?" Label="Min Risk Level" Value="@_minRiskLevel" 
                       ValueChanged="@OnFilterChanged" Dense="true" Style="width: 150px">
                <MudSelectItem T="RiskLevel?" Value="@((RiskLevel?)null)">All</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.Medium">Medium+</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.High">High+</MudSelectItem>
                <MudSelectItem T="RiskLevel?" Value="RiskLevel.Critical">Critical Only</MudSelectItem>
            </MudSelect>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudChip T="string" Color="Color.Warning">@_reviews.Count Pending</MudChip>
            <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="@LoadReviews">Refresh</MudButton>
        </MudStack>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (!_reviews.Any())
    {
        <MudAlert Severity="Severity.Success" Class="mt-4">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
            No pending reviews! All caught up.
        </MudAlert>
    }
    else
    {
        @foreach (var review in _reviews)
        {
            <MudCard Class="mb-3" Elevation="1">
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="3">
                            <MudStack>
                                <MudText Typo="Typo.caption">Transaction ID</MudText>
                                <MudText>@(review.Transaction.ExternalId.Length > 16 ? review.Transaction.ExternalId[..16] + "..." : review.Transaction.ExternalId)</MudText>
                                <MudText Typo="Typo.caption" Class="mt-2">Amount</MudText>
                                <MudText Typo="Typo.h6">@review.Transaction.Amount.ToString("C2") @review.Transaction.SourceCurrency</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="2">
                            <MudStack AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption">Risk Score</MudText>
                                <MudProgressCircular Color="@GetRiskColor(review.RiskLevel)" 
                                                     Size="Size.Medium" Value="@review.RiskScore">
                                    <MudText Typo="Typo.body2">@review.RiskScore</MudText>
                                </MudProgressCircular>
                                <MudChip T="string" Color="@GetRiskColor(review.RiskLevel)" Size="Size.Small">
                                    @review.RiskLevel
                                </MudChip>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.caption">Risk Summary</MudText>
                            <MudText Typo="Typo.body2" Style="max-height: 60px; overflow: hidden;">
                                @review.Explanation
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mt-2">
                                @review.RiskFactors.Count risk factor(s) detected
                            </MudText>
                            @if (review.ReviewStatus == ReviewStatus.Escalated)
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2" NoIcon="true">
                                    <MudText Typo="Typo.caption"><strong>Escalated by:</strong> @review.ReviewedBy</MudText>
                                    <MudText Typo="Typo.caption">@review.ReviewedAt?.ToString("MMM dd, HH:mm")</MudText>
                                </MudAlert>
                            }
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudStack>
                                <MudButton Variant="Variant.Filled" Color="Color.Success" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.CheckCircle"
                                           OnClick="@(() => OpenApproveDialog(review))"
                                           Disabled="@_processing">
                                    Approve
                                </MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Error" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Cancel"
                                           OnClick="@(() => OpenRejectDialog(review))"
                                           Disabled="@_processing">
                                    Reject
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                           FullWidth="true" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Visibility"
                                           Href="@($"/transactions/{review.TransactionId}")">
                                    View Details
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        }
    }
</MudPaper>

@code {
    private bool _loading = true;
    private bool _processing = false;
    private List<RiskAnalysis> _reviews = new();
    private RiskLevel? _minRiskLevel;
    private RiskAnalysis? _selectedReview;
    private string _reviewNotes = "";
    private bool _showApproveDialog = false;
    private bool _showRejectDialog = false;
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadReviews();
        await SetupSignalRConnection();
    }

    private async Task SetupSignalRConnection()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/transactions"))
            .WithAutomaticReconnect()
            .Build();
        
        _hubConnection.On<TransactionNotification>("NewTransaction", async (notification) =>
        {
            // Auto-refresh if a Medium+ risk transaction comes in
            if (notification.RiskLevel >= RiskLevel.Medium)
            {
                await LoadReviews();
                Snackbar.Add($"New {notification.RiskLevel} risk transaction requires review", Severity.Warning);
            }
        });
        
        try
        {
            await _hubConnection.StartAsync();
        }
        catch
        {
            // SignalR will auto-reconnect
        }
    }

    private async Task LoadReviews()
    {
        _loading = true;
        try
        {
            var reviews = await ReviewService.GetPendingReviewsAsync(_minRiskLevel);
            _reviews = reviews.ToList();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnFilterChanged(RiskLevel? value)
    {
        _minRiskLevel = value;
        await LoadReviews();
    }

    private void OpenApproveDialog(RiskAnalysis review)
    {
        _selectedReview = review;
        _reviewNotes = "";
        _showApproveDialog = true;
    }

    private void OpenRejectDialog(RiskAnalysis review)
    {
        _selectedReview = review;
        _reviewNotes = "";
        _showRejectDialog = true;
    }

    private async Task ApproveReview()
    {
        if (_selectedReview == null) return;
        
        _processing = true;
        _showApproveDialog = false;
        try
        {
            await ReviewService.ApproveAsync(_selectedReview.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add($"Transaction approved", Severity.Success);
            _reviews.Remove(_selectedReview);
            _reviewNotes = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RejectReview()
    {
        if (_selectedReview == null) return;
        
        _processing = true;
        _showRejectDialog = false;
        try
        {
            await ReviewService.RejectAsync(_selectedReview.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add($"Transaction rejected", Severity.Warning);
            _reviews.Remove(_selectedReview);
            _reviewNotes = "";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private Color GetRiskColor(RiskLevel level) => level switch
    {
        RiskLevel.Low => Color.Success,
        RiskLevel.Medium => Color.Warning,
        RiskLevel.High => Color.Error,
        RiskLevel.Critical => Color.Dark,
        _ => Color.Default
    };

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
