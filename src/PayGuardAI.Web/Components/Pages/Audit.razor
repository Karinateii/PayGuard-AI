@page "/audit"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireManager")]
@inject PayGuardAI.Data.ApplicationDbContext DbContext
@using Microsoft.EntityFrameworkCore

<PageTitle>Audit Log - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
    Audit Trail
</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4">
    Complete audit trail of all system actions for regulatory compliance and forensic analysis.
</MudAlert>

<MudPaper Class="pa-4" Elevation="2">
    <!-- Filters: 2 cols on mobile, 3 on tablet, 4 on desktop -->
    <MudGrid Spacing="2" Class="mb-2">
        <MudItem xs="6" sm="4" md="3">
            <MudTextField T="string" Label="Search" @bind-Value="_searchTerm"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" Dense="true" FullWidth="@true"
                          Placeholder="User, entity ID, notes..." />
        </MudItem>
        <MudItem xs="6" sm="4" md="3">
            <MudSelect T="string" Label="Action Type" @bind-Value="_actionFilter"
                       Dense="true" Variant="Variant.Outlined" FullWidth="@true">
                <MudSelectItem T="string" Value="@((string)null!)">All Actions</MudSelectItem>
                <MudSelectItem T="string" Value="@("TRANSACTION_ANALYZED")">Transaction Analyzed</MudSelectItem>
                <MudSelectItem T="string" Value="@("REVIEW_APPROVED")">Review Approved</MudSelectItem>
                <MudSelectItem T="string" Value="@("REVIEW_REJECTED")">Review Rejected</MudSelectItem>
                <MudSelectItem T="string" Value="@("REVIEW_ESCALATED")">Review Escalated</MudSelectItem>
                <MudSelectItem T="string" Value="@("RULE_UPDATED")">Rule Updated</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="6" sm="4" md="2">
            <MudDatePicker Label="From Date" Date="@_fromDate" DateChanged="@OnFromDateChanged"
                           Variant="Variant.Outlined" Clearable="true" />
        </MudItem>
        <MudItem xs="6" sm="4" md="2">
            <MudDatePicker Label="To Date" Date="@_toDate" DateChanged="@OnToDateChanged"
                           Variant="Variant.Outlined" Clearable="true" />
        </MudItem>
    </MudGrid>
    <!-- Action Buttons -->
    <MudStack Row="true" Spacing="2" Class="mb-3">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.FilterAlt" OnClick="@LoadAuditLogs">
            Apply Filters
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.ClearAll" OnClick="@ClearFilters">
            Clear
        </MudButton>
        @if (FilteredLogs.Any())
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="d-flex align-center">
                Showing @FilteredLogs.Count() of @_auditLogs.Count entries
            </MudText>
        }
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
            Showing @FilteredLogs.Count() of @_auditLogs.Count entries
        </MudText>
        <MudTable Items="@FilteredLogs" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Action</MudTh>
                <MudTh>Entity</MudTh>
                <MudTh>Entity ID</MudTh>
                <MudTh>Performed By</MudTh>
                <MudTh>Notes</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="@GetActionColor(context.Action)">
                        @context.Action
                    </MudChip>
                </MudTd>
                <MudTd>@context.EntityType</MudTd>
                <MudTd>
                    <MudText Typo="Typo.body2" Style="font-family: monospace;">
                        @(context.EntityId.Length > 12 ? context.EntityId[..12] + "..." : context.EntityId)
                    </MudText>
                </MudTd>
                <MudTd>@context.PerformedBy</MudTd>
                <MudTd>
                    @if (!string.IsNullOrEmpty(context.Notes))
                    {
                        <MudTooltip Text="@context.Notes">
                            <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" />
                        </MudTooltip>
                    }
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    }
</MudPaper>

@code {
    private bool _loading = true;
    private List<AuditLog> _auditLogs = new();
    private string? _searchTerm;
    private string? _actionFilter;
    private DateTime? _fromDate;
    private DateTime? _toDate;

    private IEnumerable<AuditLog> FilteredLogs => _auditLogs
        .Where(l => string.IsNullOrEmpty(_actionFilter) || l.Action == _actionFilter)
        .Where(l => _fromDate == null || l.CreatedAt.Date >= _fromDate.Value.Date)
        .Where(l => _toDate == null || l.CreatedAt.Date <= _toDate.Value.Date)
        .Where(l => string.IsNullOrEmpty(_searchTerm) || 
                    l.EntityId.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    l.PerformedBy.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    l.Action.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (l.Notes?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

    private void ClearFilters()
    {
        _searchTerm = null;
        _actionFilter = null;
        _fromDate = null;
        _toDate = null;
    }

    private Task OnFromDateChanged(DateTime? date)
    {
        _fromDate = date;
        return Task.CompletedTask;
    }

    private Task OnToDateChanged(DateTime? date)
    {
        _toDate = date;
        return Task.CompletedTask;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAuditLogs();
    }

    private async Task LoadAuditLogs()
    {
        _loading = true;
        try
        {
            _auditLogs = await DbContext.AuditLogs
                .OrderByDescending(l => l.CreatedAt)
                .Take(500)
                .ToListAsync();
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetActionColor(string action) => action switch
    {
        "TRANSACTION_ANALYZED" => Color.Info,
        "REVIEW_APPROVED" => Color.Success,
        "REVIEW_REJECTED" => Color.Error,
        "REVIEW_ESCALATED" => Color.Warning,
        "RULE_UPDATED" => Color.Secondary,
        _ => Color.Default
    };
}
