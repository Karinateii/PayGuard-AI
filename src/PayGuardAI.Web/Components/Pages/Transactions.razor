@page "/transactions"
@page "/transactions/{TransactionId:guid}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ITransactionService TransactionService
@inject IReviewService ReviewService
@inject ISnackbar Snackbar
@inject PayGuardAI.Web.Services.CurrentUserService CurrentUser

<PageTitle>Transactions - PayGuard AI</PageTitle>

<!-- Approve Dialog - Centered modal above the drawer -->
<MudOverlay Visible="_showApproveDialog" DarkBackground="false" AutoClose="false" Style="background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <MudPaper Class="pa-6" Style="max-width: 380px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" Color="Color.Success" />
                Approve Transaction
            </MudText>
            @if (_selectedTransaction != null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    ID: <strong>@_selectedTransaction.ExternalId</strong>
                </MudText>
                <MudDivider Class="my-2" />
                <MudTextField @bind-Value="_reviewNotes" Label="Approval Notes" Required="true"
                              Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense"
                              Placeholder="Explain why..." Class="mb-3"
                              RequiredError="Notes required" />
                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                    <MudButton OnClick="@(() => _showApproveDialog = false)" Size="Size.Small">Cancel</MudButton>
                    <MudButton Color="Color.Success" Variant="Variant.Filled" Size="Size.Small" OnClick="@ApproveTransaction"
                               Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Approve</MudButton>
                </MudStack>
            }
        </MudStack>
    </MudPaper>
</MudOverlay>

<!-- Reject Dialog - Centered modal above the drawer -->
<MudOverlay Visible="_showRejectDialog" DarkBackground="false" AutoClose="false" Style="background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <MudPaper Class="pa-6" Style="max-width: 380px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" Color="Color.Error" />
                Reject Transaction
            </MudText>
            @if (_selectedTransaction != null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    ID: <strong>@_selectedTransaction.ExternalId</strong>
                </MudText>
                <MudDivider Class="my-2" />
                <MudTextField @bind-Value="_reviewNotes" Label="Rejection Reason" Required="true"
                              Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense"
                              Placeholder="Explain why..." Class="mb-3"
                              RequiredError="Reason required" />
                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                    <MudButton OnClick="@(() => _showRejectDialog = false)" Size="Size.Small">Cancel</MudButton>
                    <MudButton Color="Color.Error" Variant="Variant.Filled" Size="Size.Small" OnClick="@RejectTransaction"
                               Disabled="@string.IsNullOrWhiteSpace(_reviewNotes)">Reject</MudButton>
                </MudStack>
            }
        </MudStack>
    </MudPaper>
</MudOverlay>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
    Transaction Monitor
</MudText>

@if (TransactionId.HasValue && _selectedTransaction != null)
{
    <!-- Transaction Detail View -->
    <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" 
               OnClick="@(() => NavigateToList())" Class="mb-3">
        Back to List
    </MudButton>

    <MudGrid>
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Transaction Details</MudText>
                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">External ID</MudText>
                        <MudText>@_selectedTransaction.ExternalId</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">Type</MudText>
                        <MudText>@_selectedTransaction.Type</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">Amount</MudText>
                        <MudText Typo="Typo.h5">@_selectedTransaction.Amount.ToString("N2") @_selectedTransaction.SourceCurrency</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">Corridor</MudText>
                        <MudText>@_selectedTransaction.SourceCountry → @_selectedTransaction.DestinationCountry</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">Sender ID</MudText>
                        <MudText>@_selectedTransaction.SenderId</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">Received At</MudText>
                        <MudText>@_selectedTransaction.ReceivedAt.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Risk Factors (XAI) -->
            @if (_selectedTransaction.RiskAnalysis?.RiskFactors.Any() == true)
            {
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Psychology" Class="mr-2" />
                        Risk Factors (Explainable AI)
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Primary">
                        @_selectedTransaction.RiskAnalysis.Explanation
                    </MudText>
                    <MudTable Items="@_selectedTransaction.RiskAnalysis.RiskFactors" Dense="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Category</MudTh>
                            <MudTh>Rule</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh>Score Impact</MudTh>
                            <MudTh>Severity</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Category</MudTd>
                            <MudTd>@context.RuleName</MudTd>
                            <MudTd>@context.Description</MudTd>
                            <MudTd>+@context.ScoreContribution</MudTd>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small" Color="@GetSeverityColor(context.Severity)">
                                    @context.Severity
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            }
        </MudItem>

        <MudItem xs="12" md="4">
            <!-- Risk Analysis Summary -->
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Risk Analysis</MudText>
                @if (_selectedTransaction.RiskAnalysis != null)
                {
                    <MudStack AlignItems="AlignItems.Center" Class="mb-4">
                        <MudProgressCircular Color="@GetRiskColor(_selectedTransaction.RiskAnalysis.RiskLevel)" 
                                             Size="Size.Large" Value="@_selectedTransaction.RiskAnalysis.RiskScore">
                            <MudText Typo="Typo.h4">@_selectedTransaction.RiskAnalysis.RiskScore</MudText>
                        </MudProgressCircular>
                        <MudChip T="string" Color="@GetRiskColor(_selectedTransaction.RiskAnalysis.RiskLevel)" Size="Size.Medium" Style="@GetRiskStyle(_selectedTransaction.RiskAnalysis.RiskLevel)">
                            @_selectedTransaction.RiskAnalysis.RiskLevel Risk
                        </MudChip>
                    </MudStack>

                    <MudDivider Class="mb-3" />

                    <MudText Typo="Typo.caption">Review Status</MudText>
                    <MudChip T="string" Color="@GetStatusColor(_selectedTransaction.RiskAnalysis.ReviewStatus)" Class="mb-3">
                        @_selectedTransaction.RiskAnalysis.ReviewStatus
                    </MudChip>

                    @if (_selectedTransaction.RiskAnalysis.ReviewStatus == ReviewStatus.Escalated)
                    {
                        <MudDivider Class="mb-3" />
                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                            <MudText Typo="Typo.body2">
                                <strong>Escalated by:</strong> @_selectedTransaction.RiskAnalysis.ReviewedBy
                                on @_selectedTransaction.RiskAnalysis.ReviewedAt?.ToString("MMM dd, yyyy HH:mm")
                            </MudText>
                            @if (!string.IsNullOrEmpty(_selectedTransaction.RiskAnalysis.ReviewNotes))
                            {
                                <MudText Typo="Typo.caption">Note: @_selectedTransaction.RiskAnalysis.ReviewNotes</MudText>
                            }
                        </MudAlert>
                    }

                    @if (_selectedTransaction.RiskAnalysis.ReviewStatus == ReviewStatus.Pending ||
                         (_selectedTransaction.RiskAnalysis.ReviewStatus == ReviewStatus.Escalated && _isManagerOrAbove))
                    {
                        <MudDivider Class="mb-3" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            @if (_selectedTransaction.RiskAnalysis.ReviewStatus == ReviewStatus.Escalated)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.PriorityHigh" Color="Color.Warning" Size="Size.Small" Class="mr-1" />
                                @:Escalated — Senior Review Required
                            }
                            else
                            {
                                @:Human-in-the-Loop Review
                            }
                        </MudText>
                        <MudStack Spacing="2">
                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                       OnClick="@(() => OpenApproveDialog())" Disabled="@_processing">
                                Approve
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Error" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Cancel"
                                       OnClick="@(() => OpenRejectDialog())" Disabled="@_processing">
                                Reject
                            </MudButton>
                            @if (_selectedTransaction.RiskAnalysis.ReviewStatus == ReviewStatus.Pending
                                 && !_isManagerOrAbove)
                            {
                                <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Escalator"
                                           OnClick="@(() => EscalateTransaction())" Disabled="@_processing">
                                    Escalate
                                </MudButton>
                            }
                        </MudStack>
                    }
                    else if (_selectedTransaction.RiskAnalysis.ReviewStatus == ReviewStatus.Escalated && !_isManagerOrAbove)
                    {
                        <MudDivider Class="mb-3" />
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.PriorityHigh" Size="Size.Small" Class="mr-1" />
                            This transaction has been escalated for senior review. 
                            A manager or admin will handle the final decision.
                        </MudAlert>
                    }
                    else if (_selectedTransaction.RiskAnalysis.ReviewedAt.HasValue)
                    {
                        <MudDivider Class="mb-3" />
                        <MudText Typo="Typo.caption">Reviewed By</MudText>
                        <MudText>@_selectedTransaction.RiskAnalysis.ReviewedBy</MudText>
                        <MudText Typo="Typo.caption" Class="mt-2">Reviewed At</MudText>
                        <MudText>@_selectedTransaction.RiskAnalysis.ReviewedAt?.ToString("yyyy-MM-dd HH:mm")</MudText>
                        @if (!string.IsNullOrEmpty(_selectedTransaction.RiskAnalysis.ReviewNotes))
                        {
                            <MudText Typo="Typo.caption" Class="mt-2">Notes</MudText>
                            <MudText>@_selectedTransaction.RiskAnalysis.ReviewNotes</MudText>
                        }
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No risk analysis available</MudAlert>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
}
else
{
    <!-- Transaction List View -->
    <MudPaper Class="pa-4" Elevation="2">
        <!-- Filters: 2 cols on mobile, 3 on tablet, 6 on desktop -->
        <MudGrid Spacing="2" Class="mb-2">
            <MudItem xs="6" sm="4" md="2">
                <MudSelect T="RiskLevel?" Label="Risk Level" Value="@_filterRiskLevel"
                           ValueChanged="@OnRiskLevelFilterChanged" Dense="true" Variant="Variant.Outlined" FullWidth="true">
                    <MudSelectItem T="RiskLevel?" Value="@((RiskLevel?)null)">All</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="RiskLevel.Low">Low</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="RiskLevel.Medium">Medium</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="RiskLevel.High">High</MudSelectItem>
                    <MudSelectItem T="RiskLevel?" Value="RiskLevel.Critical">Critical</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudSelect T="ReviewStatus?" Label="Status" Value="@_filterStatus"
                           ValueChanged="@OnStatusFilterChanged" Dense="true" Variant="Variant.Outlined" FullWidth="true">
                    <MudSelectItem T="ReviewStatus?" Value="@((ReviewStatus?)null)">All</MudSelectItem>
                    <MudSelectItem T="ReviewStatus?" Value="ReviewStatus.Pending">Pending</MudSelectItem>
                    <MudSelectItem T="ReviewStatus?" Value="ReviewStatus.Approved">Approved</MudSelectItem>
                    <MudSelectItem T="ReviewStatus?" Value="ReviewStatus.Rejected">Rejected</MudSelectItem>
                    <MudSelectItem T="ReviewStatus?" Value="ReviewStatus.Escalated">Escalated</MudSelectItem>
                    <MudSelectItem T="ReviewStatus?" Value="ReviewStatus.AutoApproved">Auto-Approved</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudDatePicker Label="From Date" Date="@_filterFromDate" DateChanged="@OnFromDateChanged"
                               Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudDatePicker Label="To Date" Date="@_filterToDate" DateChanged="@OnToDateChanged"
                               Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudNumericField @bind-Value="_filterMinAmount" Label="Min ($)" Variant="Variant.Outlined"
                                 FullWidth="true" Min="0" Step="100"
                                 Placeholder="e.g. 100" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudNumericField @bind-Value="_filterMaxAmount" Label="Max ($)" Variant="Variant.Outlined"
                                 FullWidth="true" Min="0" Step="100"
                                 Placeholder="e.g. 5000" />
            </MudItem>
        </MudGrid>
        <!-- Action Buttons -->
        <MudStack Row="true" Spacing="2" Class="mb-3" Style="flex-wrap: wrap;">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.FilterAlt" OnClick="@LoadTransactions">
                Apply Filters
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.ClearAll" OnClick="@ClearFilters">
                Clear
            </MudButton>
            @if (_transactions.Any())
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="d-flex align-center">
                    Showing @_transactions.Count result@(_transactions.Count == 1 ? "" : "s")
                </MudText>
            }
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <MudTable Items="@_transactions" Hover="true" Dense="true" OnRowClick="@OnRowClick" T="Transaction"
                      @bind-RowsPerPage="_rowsPerPage" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>External ID</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh>Corridor</MudTh>
                    <MudTh>Risk Score</MudTh>
                    <MudTh>Risk Level</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Received</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="External ID">@(context.ExternalId.Length > 12 ? context.ExternalId[..12] + "..." : context.ExternalId)</MudTd>
                    <MudTd DataLabel="Type">@context.Type</MudTd>
                    <MudTd DataLabel="Amount">@context.Amount.ToString("N2") @context.SourceCurrency</MudTd>
                    <MudTd DataLabel="Corridor">@context.SourceCountry → @context.DestinationCountry</MudTd>
                    <MudTd DataLabel="Risk Score">
                        <MudChip T="string" Size="Size.Small" Color="@GetRiskColor(context.RiskAnalysis?.RiskLevel)" Style="@GetRiskStyle(context.RiskAnalysis?.RiskLevel)">
                            @(context.RiskAnalysis?.RiskScore ?? 0)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Risk Level">
                        <MudChip T="string" Size="Size.Small" Color="@GetRiskColor(context.RiskAnalysis?.RiskLevel)" Style="@GetRiskStyle(context.RiskAnalysis?.RiskLevel)">
                            @(context.RiskAnalysis?.RiskLevel.ToString() ?? "N/A")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.RiskAnalysis?.ReviewStatus)">
                            @(context.RiskAnalysis?.ReviewStatus.ToString() ?? "N/A")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Received">@context.ReceivedAt.ToString("MM/dd HH:mm")</MudTd>
                    <MudTd DataLabel="">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary"
                                       OnClick="@(() => OpenQuickView(context))" />
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[]{10, 25, 50}" RowsPerPageString="Per page:" />
                </PagerContent>
            </MudTable>
        }
    </MudPaper>
    
    <!-- Quick View Drawer -->
    <MudDrawer @bind-Open="_drawerOpen" Anchor="Anchor.End" Elevation="4" 
               Width="@GetDrawerWidth()" Variant="DrawerVariant.Temporary">
        @if (_selectedTransaction != null)
        {
            <MudDrawerHeader>
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                    <MudText Typo="Typo.h6">Quick View</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@CloseDrawer" />
                </MudStack>
            </MudDrawerHeader>
            <MudDrawerContainer Class="pa-4">
                <!-- Risk Score Circle -->
                <MudStack AlignItems="AlignItems.Center" Class="mb-4">
                    @if (_selectedTransaction.RiskAnalysis != null)
                    {
                        <MudProgressCircular Color="@GetRiskColor(_selectedTransaction.RiskAnalysis.RiskLevel)" 
                                             Size="Size.Large" Value="@_selectedTransaction.RiskAnalysis.RiskScore"
                                             Class="d-flex align-center justify-center">
                            <MudText Typo="Typo.h4" Class="text-center">@_selectedTransaction.RiskAnalysis.RiskScore</MudText>
                        </MudProgressCircular>
                        <MudChip T="string" Color="@GetRiskColor(_selectedTransaction.RiskAnalysis.RiskLevel)" Size="Size.Medium" Style="@GetRiskStyle(_selectedTransaction.RiskAnalysis.RiskLevel)">
                            @_selectedTransaction.RiskAnalysis.RiskLevel Risk
                        </MudChip>
                    }
                </MudStack>
                
                <MudDivider Class="mb-3" />
                
                <!-- Transaction Info -->
                <MudGrid Spacing="2">
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Primary">Amount</MudText>
                        <MudText Typo="Typo.h6">@_selectedTransaction.Amount.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption">@_selectedTransaction.SourceCurrency → @_selectedTransaction.DestinationCurrency</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Primary">Corridor</MudText>
                        <MudText Typo="Typo.h6">@_selectedTransaction.SourceCountry → @_selectedTransaction.DestinationCountry</MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Primary">Transaction ID</MudText>
                        <MudText Typo="Typo.body2" Style="word-break: break-all;">@_selectedTransaction.ExternalId</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Primary">Type</MudText>
                        <MudText>@_selectedTransaction.Type</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Primary">Received</MudText>
                        <MudText>@_selectedTransaction.ReceivedAt.ToString("yyyy-MM-dd HH:mm")</MudText>
                    </MudItem>
                </MudGrid>
                
                @if (_selectedTransaction.RiskAnalysis?.RiskFactors.Any() == true)
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Psychology" Size="Size.Small" Class="mr-1" />
                        Risk Factors
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Secondary">
                        @_selectedTransaction.RiskAnalysis.Explanation
                    </MudText>
                    <MudStack Spacing="2">
                        @foreach (var factor in _selectedTransaction.RiskAnalysis.RiskFactors)
                        {
                            <MudPaper Class="pa-2" Outlined="true">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2">@factor.RuleName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@factor.Description</MudText>
                                    </MudStack>
                                    <MudChip T="string" Size="Size.Small" Color="@GetSeverityColor(factor.Severity)">
                                        +@factor.ScoreContribution
                                    </MudChip>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
                
                @if (_selectedTransaction.RiskAnalysis?.ReviewStatus == ReviewStatus.Pending ||
                     (_selectedTransaction.RiskAnalysis?.ReviewStatus == ReviewStatus.Escalated && _isManagerOrAbove))
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        @if (_selectedTransaction.RiskAnalysis?.ReviewStatus == ReviewStatus.Escalated)
                        {
                            @:⚠️ Escalated — Senior Review
                        }
                        else
                        {
                            @:Quick Actions
                        }
                    </MudText>
                    <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                        <MudButton Variant="Variant.Filled" Color="Color.Success" 
                                   StartIcon="@Icons.Material.Filled.CheckCircle" Class="mobile-action-btn"
                                   OnClick="@(() => OpenApproveDialog())" Disabled="@_processing">
                            Approve
                        </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Error" 
                                   StartIcon="@Icons.Material.Filled.Cancel" Class="mobile-action-btn"
                                   OnClick="@(() => OpenRejectDialog())" Disabled="@_processing">
                            Reject
                        </MudButton>
                        @if (_selectedTransaction.RiskAnalysis?.ReviewStatus == ReviewStatus.Pending
                             && !_isManagerOrAbove)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" 
                                       StartIcon="@Icons.Material.Filled.Escalator" Class="mobile-action-btn"
                                       OnClick="@(() => EscalateFromDrawer())" Disabled="@_processing">
                                Escalate
                            </MudButton>
                        }
                    </MudStack>
                }
                else if (_selectedTransaction.RiskAnalysis?.ReviewStatus == ReviewStatus.Escalated && !_isManagerOrAbove)
                {
                    <MudDivider Class="my-4" />
                    <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                        Escalated for senior review.
                    </MudAlert>
                }
                
                <MudDivider Class="my-4" />
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.OpenInNew"
                           OnClick="@ViewFullDetails">
                    View Full Details
                </MudButton>
            </MudDrawerContainer>
        }
    </MudDrawer>
}

@code {
    [Parameter]
    public Guid? TransactionId { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnTo { get; set; }

    private bool _loading = true;
    private bool _processing = false;
    private bool _drawerOpen = false;
    private bool _isManagerOrAbove = false;
    private int _rowsPerPage = 10;
    private List<Transaction> _transactions = new();
    private Transaction? _selectedTransaction;
    private RiskLevel? _filterRiskLevel;
    private ReviewStatus? _filterStatus;
    private DateTime? _filterFromDate;
    private DateTime? _filterToDate;
    private decimal? _filterMinAmount;
    private decimal? _filterMaxAmount;
    private bool _showApproveDialog = false;
    private bool _showRejectDialog = false;
    private string _reviewNotes = "";

    [CascadingParameter(Name = "OnReviewCompleted")]
    private Func<Task>? OnReviewCompleted { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Determine if current user is Manager/Admin/SuperAdmin — they shouldn't see Escalate
        var role = CurrentUser.PrimaryRole;
        _isManagerOrAbove = role is "Manager" or "Admin" or "SuperAdmin";
        
        await LoadTransactions();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (TransactionId.HasValue)
        {
            _selectedTransaction = await TransactionService.GetByIdAsync(TransactionId.Value);
        }
        else
        {
            _selectedTransaction = null;
        }
    }

    private async Task LoadTransactions()
    {
        _loading = true;
        try
        {
            var transactions = await TransactionService.GetTransactionsAsync(
                pageNumber: 1,
                pageSize: 50,
                riskLevel: _filterRiskLevel,
                reviewStatus: _filterStatus);
            
            // Apply client-side filters for date and amount
            var filtered = transactions.AsEnumerable();
            
            if (_filterFromDate.HasValue)
            {
                filtered = filtered.Where(t => t.ReceivedAt.Date >= _filterFromDate.Value.Date);
            }
            
            if (_filterToDate.HasValue)
            {
                filtered = filtered.Where(t => t.ReceivedAt.Date <= _filterToDate.Value.Date);
            }
            
            if (_filterMinAmount.HasValue)
            {
                filtered = filtered.Where(t => t.Amount >= _filterMinAmount.Value);
            }
            
            if (_filterMaxAmount.HasValue)
            {
                filtered = filtered.Where(t => t.Amount <= _filterMaxAmount.Value);
            }
            
            _transactions = filtered.ToList();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnRiskLevelFilterChanged(RiskLevel? value)
    {
        _filterRiskLevel = value;
        await LoadTransactions();
    }

    private async Task OnStatusFilterChanged(ReviewStatus? value)
    {
        _filterStatus = value;
        await LoadTransactions();
    }

    private async Task OnFromDateChanged(DateTime? value)
    {
        _filterFromDate = value;
        await LoadTransactions();
    }

    private async Task OnToDateChanged(DateTime? value)
    {
        _filterToDate = value;
        await LoadTransactions();
    }

    private async Task OnAmountFilterChanged()
    {
        await LoadTransactions();
    }

    private async Task ClearFilters()
    {
        _filterRiskLevel = null;
        _filterStatus = null;
        _filterFromDate = null;
        _filterToDate = null;
        _filterMinAmount = null;
        _filterMaxAmount = null;
        await LoadTransactions();
    }

    private void OnRowClick(TableRowClickEventArgs<Transaction> args)
    {
        _selectedTransaction = args.Item;
        _drawerOpen = true;
    }

    private void OpenQuickView(Transaction transaction)
    {
        _selectedTransaction = transaction;
        _drawerOpen = true;
    }

    private void CloseDrawer()
    {
        _drawerOpen = false;
        _selectedTransaction = null;
        // Only navigate away if we came from another page
        if (!string.IsNullOrEmpty(ReturnTo))
        {
            NavigationManager.NavigateTo(ReturnTo);
        }
    }
    
    private void ViewFullDetails()
    {
        if (_selectedTransaction != null)
        {
            NavigationManager.NavigateTo($"/transactions/{_selectedTransaction.Id}");
        }
    }

    private void NavigateToList()
    {
        if (!string.IsNullOrEmpty(ReturnTo))
        {
            NavigationManager.NavigateTo(ReturnTo);
        }
        else
        {
            NavigationManager.NavigateTo("/transactions");
        }
    }

    private void OpenApproveDialog()
    {
        _reviewNotes = "";
        _showApproveDialog = true;
    }

    private void OpenRejectDialog()
    {
        _reviewNotes = "";
        _showRejectDialog = true;
    }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    private async Task ApproveTransaction()
    {
        if (_selectedTransaction?.RiskAnalysis == null) return;
        _processing = true;
        _showApproveDialog = false;
        try
        {
            await ReviewService.ApproveAsync(_selectedTransaction.RiskAnalysis.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add("Transaction approved successfully", Severity.Success);
            _selectedTransaction = await TransactionService.GetByIdAsync(_selectedTransaction.Id);
            await LoadTransactions();
            _reviewNotes = "";
            if (OnReviewCompleted != null) await OnReviewCompleted();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RejectTransaction()
    {
        if (_selectedTransaction?.RiskAnalysis == null) return;
        _processing = true;
        _showRejectDialog = false;
        try
        {
            await ReviewService.RejectAsync(_selectedTransaction.RiskAnalysis.Id, CurrentUser.UserName, _reviewNotes);
            Snackbar.Add("Transaction rejected", Severity.Warning);
            _selectedTransaction = await TransactionService.GetByIdAsync(_selectedTransaction.Id);
            await LoadTransactions();
            _reviewNotes = "";
            if (OnReviewCompleted != null) await OnReviewCompleted();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task EscalateTransaction()
    {
        if (_selectedTransaction?.RiskAnalysis == null) return;
        _processing = true;
        try
        {
            await ReviewService.EscalateAsync(_selectedTransaction.RiskAnalysis.Id, CurrentUser.UserName);
            Snackbar.Add("Transaction escalated for senior review", Severity.Info);
            _selectedTransaction = await TransactionService.GetByIdAsync(_selectedTransaction.Id);
            await LoadTransactions();
            if (OnReviewCompleted != null) await OnReviewCompleted();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }
    
    private async Task EscalateFromDrawer()
    {
        await EscalateTransaction();
        await LoadTransactions();
    }

    private string GetDrawerWidth() => "min(520px, 100vw)";  // 520px on desktop, full viewport on mobile

    private Color GetRiskColor(RiskLevel? level) => level switch
    {
        RiskLevel.Low => Color.Success,      // Green
        RiskLevel.Medium => Color.Warning,   // Orange
        RiskLevel.High => Color.Error,       // Red (lighter shade)
        RiskLevel.Critical => Color.Error,   // Red (darker/brighter - most alarming)
        _ => Color.Default
    };

    private string GetRiskStyle(RiskLevel? level) => level switch
    {
        RiskLevel.High => "opacity: 0.8;",         // Slightly muted red
        RiskLevel.Critical => "opacity: 1.0; font-weight: bold;",  // Bright, bold red
        _ => ""
    };

    private Color GetStatusColor(ReviewStatus? status) => status switch
    {
        ReviewStatus.Pending => Color.Warning,
        ReviewStatus.Approved or ReviewStatus.AutoApproved => Color.Success,
        ReviewStatus.Rejected => Color.Error,
        ReviewStatus.Escalated => Color.Info,
        _ => Color.Default
    };

    private Color GetSeverityColor(FactorSeverity severity) => severity switch
    {
        FactorSeverity.Info => Color.Info,
        FactorSeverity.Warning => Color.Warning,
        FactorSeverity.Alert => Color.Error,
        FactorSeverity.Critical => Color.Dark,
        _ => Color.Default
    };
}
