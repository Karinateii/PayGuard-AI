@using PayGuardAI.Core.Services
@inject IAdvancedAnalyticsService AnalyticsService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.TableChart" Color="Color.Primary" />
            <MudText Typo="Typo.h6">@Data.ReportName</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3" Style="min-width: 700px; max-height: 70vh; overflow: auto;">
            <!-- Summary Cards -->
            @if (Data.Summary.Any())
            {
                <MudPaper Class="pa-3" Elevation="1">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Summary</MudText>
                    <MudGrid>
                        @foreach (var kvp in Data.Summary)
                        {
                            <MudItem xs="12" sm="4">
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@kvp.Key</MudText>
                                    <MudText Typo="Typo.h6">@FormatValue(kvp.Value)</MudText>
                                </MudStack>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            }

            <!-- Data Table -->
            @if (Data.Rows.Any())
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                    @Data.TotalRows rows â€¢ Generated @Data.GeneratedAt.ToString("MMM dd, yyyy HH:mm") UTC
                </MudText>
                <MudSimpleTable Hover="true" Dense="true" Bordered="true" Style="max-height: 400px; overflow: auto;">
                    <thead>
                        <tr>
                            @foreach (var header in Data.Rows.First().Keys)
                            {
                                <th style="position: sticky; top: 0; background: var(--mud-palette-surface); z-index: 1;">
                                    @header
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Data.Rows.Take(100))
                        {
                            <tr>
                                @foreach (var value in row.Values)
                                {
                                    <td>@FormatValue(value)</td>
                                }
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
                @if (Data.Rows.Count > 100)
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Showing 100 of @Data.TotalRows rows. Export to CSV for the full dataset.
                    </MudAlert>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Warning">No data found for this report.</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="ExportCsv" Variant="Variant.Outlined" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.FileDownload" Disabled="_exporting">
            @if (_exporting) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" /> }
            Export CSV
        </MudButton>
        <MudButton OnClick="ExportText" Variant="Variant.Outlined" Color="Color.Secondary"
                   StartIcon="@Icons.Material.Filled.Description" Disabled="_exporting">
            Export Text
        </MudButton>
        <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Default">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public ReportData Data { get; set; } = new();

    private bool _exporting;

    private void Close() => MudDialog?.Close();

    private async Task ExportCsv()
    {
        try
        {
            _exporting = true;
            StateHasChanged();

            var csvBytes = await AnalyticsService.ExportReportToCsvAsync(Data);
            var fileName = $"{SanitizeFileName(Data.ReportName)}_{Data.GeneratedAt:yyyyMMdd}.csv";
            await DownloadFile(csvBytes, fileName, "text/csv");
            Snackbar.Add("CSV exported!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _exporting = false;
        }
    }

    private async Task ExportText()
    {
        try
        {
            _exporting = true;
            StateHasChanged();

            var textBytes = await AnalyticsService.ExportReportToPdfAsync(Data);
            var fileName = $"{SanitizeFileName(Data.ReportName)}_{Data.GeneratedAt:yyyyMMdd}.txt";
            await DownloadFile(textBytes, fileName, "text/plain");
            Snackbar.Add("Text report exported!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _exporting = false;
        }
    }

    private async Task DownloadFile(byte[] content, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(content);
        var script = "(function() { var link = document.createElement('a'); link.download = '"
            + fileName.Replace("'", "\\'") + "'; link.href = 'data:"
            + contentType + ";base64," + base64 + "'; link.click(); })()";
        await JS.InvokeVoidAsync("eval", script);
    }

    private string FormatValue(object? value)
    {
        return value switch
        {
            null => "",
            decimal d => d.ToString("N2"),
            double d => d.ToString("N2"),
            float f => f.ToString("N2"),
            _ => value.ToString() ?? ""
        };
    }

    private string SanitizeFileName(string name)
    {
        var invalid = System.IO.Path.GetInvalidFileNameChars();
        return new string(name.Where(c => !invalid.Contains(c)).ToArray()).Replace(' ', '_');
    }
}
