@page "/mfa/setup"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using PayGuardAI.Web.Services
@inject IMfaService MfaService
@inject IDbContextFactory<PayGuardAI.Data.ApplicationDbContext> DbFactory
@inject ITenantContext TenantContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Setup Two-Factor Authentication - PayGuard AI</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-6">
        <MudText Typo="Typo.h4" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-2" />
            Setup Two-Factor Authentication
        </MudText>

        @if (_alreadyEnabled)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                Two-factor authentication is already enabled for your account.
            </MudAlert>
            <MudText Typo="Typo.body1" Class="mb-4">
                If you want to reconfigure MFA, disable it first from your Profile page, then set it up again.
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/profile">
                Back to Profile
            </MudButton>
        }
        else if (!_setupComplete)
        {
            @if (_step == 1)
            {
                <MudText Typo="Typo.body1" Class="mb-4">
                    Scan this QR code with your authenticator app (Google Authenticator, Microsoft Authenticator, Authy, etc.)
                </MudText>

                <div class="text-center mb-4">
                    @if (!string.IsNullOrEmpty(_qrCodeUri))
                    {
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=@Uri.EscapeDataString(_qrCodeUri)" 
                             alt="MFA QR Code" 
                             style="max-width: 300px;" />
                    }
                    else
                    {
                        <MudProgressCircular Indeterminate="true" />
                    }
                </div>

                <MudAlert Severity="Severity.Info" Class="mb-4">
                    <strong>Manual Entry:</strong><br />
                    If you can't scan the QR code, enter this secret key manually:<br />
                    <MudText Typo="Typo.body2" Style="font-family: monospace; background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px; display: inline-block;">@_secret</MudText>
                </MudAlert>

                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NextStep">
                    Next
                </MudButton>
            }
            else if (_step == 2)
            {
                <MudText Typo="Typo.body1" Class="mb-4">
                    Enter the 6-digit code from your authenticator app to verify the setup
                </MudText>

                <MudTextField @bind-Value="_verificationCode"
                              Label="Verification Code"
                              Variant="Variant.Outlined"
                              MaxLength="6"
                              HelperText="Enter the 6-digit code from your app"
                              Immediate="true"
                              Class="mb-4" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
                }

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined" OnClick="PreviousStep">
                        Back
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="VerifyCode"
                               Disabled="@(string.IsNullOrWhiteSpace(_verificationCode) || _verificationCode.Length != 6 || !_verificationCode.All(char.IsDigit) || _isSaving)">
                        @if (_isSaving) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Verify &amp; Enable
                    </MudButton>
                </MudStack>
            }
            else if (_step == 3)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    <strong>Important:</strong> Save these backup codes in a secure location. 
                    You can use them to access your account if you lose your authenticator device.
                    Each code can only be used once.
                </MudAlert>

                <MudPaper Elevation="1" Class="pa-4 mb-4" Style="background-color: #f5f5f5;">
                    <MudGrid>
                        @foreach (var backupCode in _backupCodes)
                        {
                            <MudItem xs="6" sm="4">
                                <MudText Typo="Typo.body1" Style="font-family: monospace; font-size: 1.1rem;">@backupCode</MudText>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>

                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="CompleteSetup">
                    I've saved my codes — Complete Setup
                </MudButton>
            }
        }
        else
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                Two-factor authentication has been successfully enabled for your account.
            </MudAlert>

            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/profile">
                Return to Profile
            </MudButton>
        }
    </MudPaper>
</MudContainer>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private int _step = 1;
    private string _secret = string.Empty;
    private string _qrCodeUri = string.Empty;
    private string _verificationCode = string.Empty;
    private string[] _backupCodes = Array.Empty<string>();
    private string _errorMessage = string.Empty;
    private bool _setupComplete;
    private bool _alreadyEnabled;
    private bool _isSaving;
    private string _userEmail = string.Empty;
    private Guid _memberId;

    protected override async Task OnInitializedAsync()
    {
        if (AuthState != null)
        {
            var authState = await AuthState;
            _userEmail = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value
                      ?? authState.User.FindFirst("email")?.Value
                      ?? authState.User.Identity?.Name ?? "";

            // Resolve TeamMember ID
            var homeTenant = authState.User.FindFirst("tenant_id")?.Value ?? TenantContext.TenantId;
            await using var db = await DbFactory.CreateDbContextAsync();
            db.SetTenantId(homeTenant);
            var member = await db.TeamMembers
                .FirstOrDefaultAsync(m => m.Email.ToLower() == _userEmail.ToLower());

            if (member != null)
            {
                _memberId = member.Id;
                _alreadyEnabled = member.MfaEnabled;
            }
        }

        if (!_alreadyEnabled)
        {
            _secret = MfaService.GenerateSecret();
            _qrCodeUri = MfaService.GenerateQrCodeUri(_userEmail, _secret);
        }
    }

    private void NextStep() => _step++;
    private void PreviousStep() => _step--;

    private async Task VerifyCode()
    {
        _errorMessage = string.Empty;
        _isSaving = true;

        try
        {
            if (!MfaService.ValidateCode(_secret, _verificationCode))
            {
                _errorMessage = "Invalid verification code. Please try again.";
                return;
            }

            // Code is valid — generate backup codes and persist everything
            _backupCodes = MfaService.GenerateBackupCodes();
            await MfaService.EnableMfaAsync(_memberId, _secret, _backupCodes);

            Snackbar.Add("MFA enabled successfully!", Severity.Success);
            _step++;
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred while enabling MFA. Please try again.";
            _ = ex; // logged by service
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void CompleteSetup()
    {
        _setupComplete = true;
    }
}
