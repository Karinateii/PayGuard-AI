@page "/pricing"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using PayGuardAI.Core.Entities
@using PayGuardAI.Core.Services
@using PayGuardAI.Data.Services
@attribute [Authorize(Policy = "CanManageBilling")]
@inject BillingServiceFactory BillingFactory
@inject NavigationManager Nav
@inject IConfiguration Config
@inject PayGuardAI.Core.Services.ITenantContext TenantContext
@inject AuthenticationStateProvider AuthState
@inject IPlanFeatureService PlanFeatures

<PageTitle>Pricing — PayGuard AI</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
    <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-2" Style="font-weight:700">
        Simple, Transparent Pricing
    </MudText>
    <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Secondary" Class="mb-2">
        Start free for 14 days. No credit card required.
    </MudText>

    @if (_currentPlan != BillingPlan.Trial)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true" Variant="Variant.Outlined">
            <MudText Typo="Typo.body2">
                You're currently on the <strong>@PlanFeatures.GetPlanDisplayName(_currentPlan)</strong> plan.
                @if (_pendingPlan.HasValue)
                {
                    <span class="ml-1" style="color: var(--mud-palette-warning);">
                        Downgrade to <strong>@_pendingPlan.Value</strong> scheduled at end of billing period.
                    </span>
                }
                @if (_currentPlan != BillingPlan.Enterprise)
                {
                    <MudLink Href="/billing" Class="ml-1">Manage subscription →</MudLink>
                }
            </MudText>
        </MudAlert>
    }

    @if (_billingEnabled)
    {
        <MudGrid Justify="Justify.Center" Spacing="4" Class="mt-4">
            @foreach (var plan in _plans)
            {
                var isCurrentPlan = plan.Plan == _currentPlan;
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="@(plan.IsPopular ? 8 : 2)" 
                             Style="@(plan.IsPopular ? "border: 2px solid var(--mud-palette-primary); position:relative;" : isCurrentPlan ? "border: 2px solid var(--mud-palette-success); position:relative;" : "")">
                        @if (plan.IsPopular && !isCurrentPlan)
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small"
                                     Style="position:absolute; top:-14px; left:50%; transform:translateX(-50%); font-weight:700;">
                                MOST POPULAR
                            </MudChip>
                        }
                        @if (isCurrentPlan)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small"
                                     Style="position:absolute; top:-14px; left:50%; transform:translateX(-50%); font-weight:700;">
                                CURRENT PLAN
                            </MudChip>
                        }
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5" Style="font-weight:700">@plan.Name</MudText>
                                <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight:800" Class="mt-1">
                                    @plan.Price
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@plan.Description</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudList T="string" Dense="true">
                                @foreach (var feature in plan.Features)
                                {
                                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle"
                                                 IconColor="Color.Success">
                                        @feature
                                    </MudListItem>
                                }
                            </MudList>
                            @if (plan.Plan != BillingPlan.Enterprise)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    Overage: $0.10 per additional transaction
                                </MudText>
                            }
                        </MudCardContent>
                        <MudCardActions Class="px-4 pb-4">
                            @if (isCurrentPlan)
                            {
                                <MudButton Variant="Variant.Outlined" Color="Color.Success"
                                           FullWidth="true" Size="Size.Large" Disabled="true">
                                    Current Plan
                                </MudButton>
                            }
                            else if (plan.Plan > _currentPlan)
                            {
                                <MudButton Variant="Variant.Filled"
                                           Color="@(plan.IsPopular ? Color.Primary : Color.Default)"
                                           FullWidth="true" Size="Size.Large"
                                           OnClick="@(() => StartCheckout(plan.Plan))"
                                           Disabled="@_loading">
                                    @if (_loading && _checkingOutPlan == plan.Plan)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                                    }
                                    @(_currentPlan == BillingPlan.Trial ? "Get Started" : "Upgrade")
                                </MudButton>
                            }
                            else
                            {
                                @if (_pendingPlan == plan.Plan)
                                {
                                    <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                                               FullWidth="true" Size="Size.Large" Disabled="true">
                                        Downgrade Scheduled
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Outlined" Color="Color.Default"
                                               FullWidth="true" Size="Size.Large"
                                               OnClick="@(() => ScheduleDowngrade(plan.Plan))"
                                               Disabled="@_loading">
                                        @if (_loading && _checkingOutPlan == plan.Plan)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                                        }
                                        Downgrade
                                    </MudButton>
                                }
                            }
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* Plan comparison summary *@
        <MudPaper Elevation="0" Class="mt-8 pa-6" Style="background: var(--mud-palette-surface); border-radius: 12px;">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-4" Style="font-weight:700">
                Compare Plans
            </MudText>
            <MudSimpleTable Dense="true" Bordered="true" Striped="true" Style="max-width:800px; margin:auto;">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th style="text-align:center">Starter</th>
                        <th style="text-align:center">Pro</th>
                        <th style="text-align:center">Enterprise</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Monthly transactions</td><td style="text-align:center">1,000</td><td style="text-align:center">10,000</td><td style="text-align:center">Unlimited</td></tr>
                    <tr><td>Team members</td><td style="text-align:center">5</td><td style="text-align:center">25</td><td style="text-align:center">Unlimited</td></tr>
                    <tr><td>API keys</td><td style="text-align:center">2</td><td style="text-align:center">10</td><td style="text-align:center">Unlimited</td></tr>
                    <tr><td>Risk scoring</td><td style="text-align:center">Built-in rules</td><td style="text-align:center">Built-in + ML AI</td><td style="text-align:center">Built-in + ML AI</td></tr>
                    <tr><td>Custom rules</td><td style="text-align:center">—</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Rule marketplace</td><td style="text-align:center">—</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Compliance reports</td><td style="text-align:center">—</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Outbound webhooks</td><td style="text-align:center">—</td><td style="text-align:center">5 endpoints</td><td style="text-align:center">Unlimited</td></tr>
                    <tr><td>Slack alerts</td><td style="text-align:center">—</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Advanced analytics</td><td style="text-align:center">—</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Custom roles</td><td style="text-align:center">—</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Network analysis</td><td style="text-align:center">—</td><td style="text-align:center">—</td><td style="text-align:center">✓</td></tr>
                    <tr><td>Scheduled reports</td><td style="text-align:center">—</td><td style="text-align:center">—</td><td style="text-align:center">✓</td></tr>
                    <tr><td>GDPR compliance</td><td style="text-align:center">—</td><td style="text-align:center">—</td><td style="text-align:center">✓</td></tr>
                </tbody>
            </MudSimpleTable>
        </MudPaper>

        <MudPaper Elevation="0" Class="mt-8 pa-6" Style="background: var(--mud-palette-surface);">
            <MudGrid Justify="Justify.Center">
                <MudItem xs="12" md="8">
                    <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-4">
                        Frequently Asked Questions
                    </MudText>
                    <MudExpansionPanels>
                        <MudExpansionPanel Text="What happens after the 14-day trial?">
                            Your organization continues to operate normally. You'll be prompted to choose a plan.
                            If you don't subscribe, access to advanced features will be restricted until you select a plan.
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="Can I change plans later?">
                            Yes — you can upgrade or downgrade at any time from the Pricing page.
                            <strong>Upgrades</strong> take effect immediately — your old subscription is canceled and you check out on the new plan.
                            <strong>Downgrades</strong> are scheduled — you keep your current plan until the end of the paid billing period,
                            then the lower plan takes effect. No double charges.
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="What counts as a transaction?">
                            Each unique transaction received via your API webhook that PayGuard AI processes and assigns a risk score.
                            Duplicate or replayed events and system health checks are not counted.
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="How does overage billing work?">
                            Starter and Pro plans include a monthly transaction allowance. Each additional transaction beyond your limit
                            is billed at $0.10. You'll see real-time usage on your Billing dashboard and receive alerts at 80% utilization.
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="What payment methods do you accept?">
                            We accept payments via Paystack — supporting cards, bank transfers, and mobile money across Africa.
                            International payment options via Flutterwave coming soon.
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">
            Billing is coming soon. You're currently on the free plan with full access.
        </MudAlert>
    }

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@_error</MudAlert>
    }
</MudContainer>

@code {
    private IReadOnlyList<PlanInfo> _plans = [];
    private bool _billingEnabled;
    private bool _loading;
    private BillingPlan? _checkingOutPlan;
    private BillingPlan _currentPlan = BillingPlan.Trial;
    private BillingPlan? _pendingPlan;
    private string _error = string.Empty;
    private string _userEmail = "demo@payguard.ai";

    protected override async Task OnInitializedAsync()
    {
        _billingEnabled = bool.TryParse(Config["FeatureFlags:BillingEnabled"], out var b) && b;

        // Get current user's email for checkout
        try
        {
            var authState = await AuthState.GetAuthenticationStateAsync();
            var email = authState.User?.FindFirst("email")?.Value
                     ?? authState.User?.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
            if (!string.IsNullOrWhiteSpace(email))
                _userEmail = email;
        }
        catch { /* fallback to demo email */ }

        // Get current plan and check for pending downgrade
        _currentPlan = await PlanFeatures.GetCurrentPlanAsync(TenantContext.TenantId);

        if (_billingEnabled)
        {
            var billingService = BillingFactory.GetDefault();
            _plans = billingService.GetPlans();

            // Check if there's a pending downgrade
            var sub = await billingService.GetSubscriptionAsync(TenantContext.TenantId);
            _pendingPlan = sub?.PendingPlan;
        }
    }

    private async Task StartCheckout(BillingPlan plan)
    {
        _loading = true;
        _checkingOutPlan = plan;
        _error = string.Empty;
        StateHasChanged();

        try
        {
            var billingService = BillingFactory.GetDefault();

            // If tenant already has an active subscription, cancel it first
            // (only for upgrades — downgrades use ScheduleDowngrade)
            if (_currentPlan > BillingPlan.Trial)
            {
                await billingService.CancelSubscriptionAsync(TenantContext.TenantId);
            }

            // Clear any pending downgrade since they're upgrading instead
            _pendingPlan = null;

            // Do NOT add query params here — Paystack appends ?trxref=xxx&reference=xxx
            // and a double ? would break param parsing
            var baseUrl = Nav.BaseUri.TrimEnd('/');
            var callbackUrl = $"{baseUrl}/billing";

            var checkoutUrl = await billingService.CreateCheckoutSessionAsync(
                tenantId: TenantContext.TenantId,
                email: _userEmail,
                plan: plan,
                callbackUrl: callbackUrl);

            Nav.NavigateTo(checkoutUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = $"Checkout failed: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ScheduleDowngrade(BillingPlan plan)
    {
        _loading = true;
        _checkingOutPlan = plan;
        _error = string.Empty;
        StateHasChanged();

        try
        {
            var billingService = BillingFactory.GetDefault();
            await billingService.ScheduleDowngradeAsync(TenantContext.TenantId, plan);
            _pendingPlan = plan;
        }
        catch (Exception ex)
        {
            _error = $"Failed to schedule downgrade: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }
}
