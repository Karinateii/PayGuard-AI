@page "/send"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR
@using PayGuardAI.Core.Services
@using PayGuardAI.Web.Hubs
@attribute [Authorize]
@inject ITransactionService TransactionService
@inject IHubContext<TransactionHub> HubContext
@inject ITenantContext TenantContext
@inject ILogger<Send> Logger
@inject ISnackbar Snackbar

<PageTitle>Simulate Transaction - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Science" Class="mr-2" />
    Transaction Simulator
</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
    <MudText>
        Simulate real cross-border transactions through the PayGuard AI risk engine. Each simulated transaction
        goes through the full risk scoring pipeline and appears on the dashboard in real-time via SignalR.
    </MudText>
</MudAlert>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Send" Class="mr-2" Size="Size.Small" />
                Transaction Details
            </MudText>
            <MudStack Spacing="3">
                <MudNumericField T="decimal" @bind-Value="_amount" Label="Amount (USD)"
                                Variant="Variant.Outlined" Min="1" Max="100000" />
                <MudSelect T="string" @bind-Value="_sourceCountry" Label="Source Country" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("US")">United States</MudSelectItem>
                    <MudSelectItem Value="@("GB")">United Kingdom</MudSelectItem>
                    <MudSelectItem Value="@("CA")">Canada</MudSelectItem>
                    <MudSelectItem Value="@("DE")">Germany</MudSelectItem>
                    <MudSelectItem Value="@("NG")">Nigeria</MudSelectItem>
                    <MudSelectItem Value="@("ZA")">South Africa</MudSelectItem>
                </MudSelect>
                <MudSelect T="string" @bind-Value="_destinationCountry" Label="Destination Country" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("NG")">Nigeria</MudSelectItem>
                    <MudSelectItem Value="@("GH")">Ghana</MudSelectItem>
                    <MudSelectItem Value="@("KE")">Kenya</MudSelectItem>
                    <MudSelectItem Value="@("ZA")">South Africa</MudSelectItem>
                    <MudSelectItem Value="@("TZ")">Tanzania</MudSelectItem>
                    <MudSelectItem Value="@("UG")">Uganda</MudSelectItem>
                    <MudSelectItem Value="@("KP")">North Korea (Sanctioned)</MudSelectItem>
                    <MudSelectItem Value="@("SY")">Syria (Sanctioned)</MudSelectItem>
                </MudSelect>
                <MudSelect T="string" @bind-Value="_transactionType" Label="Transaction Type" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("REMITTANCE")">Remittance</MudSelectItem>
                    <MudSelectItem Value="@("BANK_TRANSFER")">Bank Transfer</MudSelectItem>
                    <MudSelectItem Value="@("MOBILE_MONEY")">Mobile Money</MudSelectItem>
                    <MudSelectItem Value="@("WALLET_TRANSFER")">Wallet Transfer</MudSelectItem>
                </MudSelect>
                <MudTextField @bind-Value="_senderId" Label="Sender ID (optional)" Variant="Variant.Outlined"
                              HelperText="Leave blank for auto-generated ID" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="@SimulateTransaction" Disabled="@_sending">
                    @if (_sending)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Simulate Transaction</span>
                    }
                </MudButton>
            </MudStack>
        </MudPaper>

        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.FlashOn" Class="mr-2" Size="Size.Small" />
                Quick Scenarios
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">One-click presets to demonstrate different risk levels</MudText>
            <MudStack Spacing="2">
                <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.CheckCircle" Disabled="@_sending"
                           OnClick='@(() => RunScenario(150, "US", "NG", "REMITTANCE", "normal-user"))'>
                    Low Risk - $150 US to Nigeria
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Warning" Disabled="@_sending"
                           OnClick='@(() => RunScenario(8500, "GB", "KE", "BANK_TRANSFER", "medium-risk-user"))'>
                    Medium Risk - $8,500 UK to Kenya
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.GppBad" Disabled="@_sending"
                           OnClick='@(() => RunScenario(15000, "NG", "KP", "REMITTANCE", "high-risk-user"))'>
                    High Risk - $15K Nigeria to N.Korea
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Block" Disabled="@_sending"
                           OnClick='@(() => RunScenario(50000, "ZA", "SY", "WALLET_TRANSFER", "critical-user"))'>
                    Critical - $50K S.Africa to Syria
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        @if (_lastResult != null)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3" Color="@GetRiskColor(_lastResult.RiskLevel)">
                    <MudIcon Icon="@GetRiskIcon(_lastResult.RiskLevel)" Class="mr-2" />
                    Transaction Processed!
                </MudText>
                <MudSimpleTable Dense="true">
                    <tbody>
                        <tr><td><strong>Transaction ID</strong></td><td>@_lastResult.TransactionId</td></tr>
                        <tr><td><strong>Amount</strong></td><td>$@_lastResult.Amount.ToString("N2")</td></tr>
                        <tr><td><strong>Route</strong></td><td>@_lastResult.SourceCountry to @_lastResult.DestinationCountry</td></tr>
                        <tr>
                            <td><strong>Risk Score</strong></td>
                            <td><MudChip T="string" Size="Size.Small" Color="@GetRiskColor(_lastResult.RiskLevel)">@_lastResult.RiskScore / 100</MudChip></td>
                        </tr>
                        <tr>
                            <td><strong>Risk Level</strong></td>
                            <td><MudChip T="string" Size="Size.Small" Color="@GetRiskColor(_lastResult.RiskLevel)">@_lastResult.RiskLevel</MudChip></td>
                        </tr>
                        <tr><td><strong>Review Status</strong></td><td>@_lastResult.ReviewStatus</td></tr>
                    </tbody>
                </MudSimpleTable>
                @if (!string.IsNullOrEmpty(_lastResult.Explanation))
                {
                    <MudAlert Severity="@GetAlertSeverity(_lastResult.RiskLevel)" Class="mt-3" Dense="true">
                        @_lastResult.Explanation
                    </MudAlert>
                }
                <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                    This transaction is now visible on the
                    <MudLink Href="/transactions">Transactions</MudLink> and
                    <MudLink Href="/reviews">Reviews</MudLink> pages.
                </MudAlert>
            </MudPaper>
        }

        @if (_history.Count > 0)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" Size="Size.Small" />
                    Session History (@_history.Count simulated)
                </MudText>
                <MudSimpleTable Dense="true" Hover="true">
                    <thead>
                        <tr><th>Amount</th><th>Route</th><th>Risk</th><th>Score</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var item in _history.AsEnumerable().Reverse().Take(10))
                        {
                            <tr>
                                <td>$@item.Amount.ToString("N0")</td>
                                <td>@item.SourceCountry to @item.DestinationCountry</td>
                                <td><MudChip T="string" Size="Size.Small" Color="@GetRiskColor(item.RiskLevel)">@item.RiskLevel</MudChip></td>
                                <td>@item.RiskScore</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        }

        @if (_lastResult == null && _history.Count == 0)
        {
            <MudPaper Class="pa-6" Elevation="2">
                <div class="text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Class="mt-3" Color="Color.Secondary">Ready to Simulate</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Fill in the details or use a quick scenario to see PayGuard AI risk engine in action.
                    </MudText>
                    <MudStack AlignItems="AlignItems.Start" Class="mt-4 mx-auto" Style="max-width: 300px;">
                        <MudText>1. Transaction ingested</MudText>
                        <MudText>2. Risk rules evaluated</MudText>
                        <MudText>3. Risk score calculated</MudText>
                        <MudText>4. Review status assigned</MudText>
                        <MudText>5. Real-time notification sent</MudText>
                    </MudStack>
                </div>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

@code {
    private decimal _amount = 500;
    private string _sourceCountry = "US";
    private string _destinationCountry = "NG";
    private string _transactionType = "REMITTANCE";
    private string _senderId = "";
    private bool _sending = false;
    private SimResult? _lastResult;
    private List<SimResult> _history = new();

    private async Task SimulateTransaction()
    {
        _sending = true;
        StateHasChanged();
        try
        {
            var transactionId = Guid.NewGuid().ToString();
            var destCurrency = GetCurrencyForCountry(_destinationCountry);
            var srcCurrency = "USD";
            var senderId = string.IsNullOrWhiteSpace(_senderId) ? $"sender-{Guid.NewGuid().ToString()[..8]}" : _senderId;

            var payload = $$"""
            {
                "event": "transaction.completed",
                "data": {
                    "id": "{{transactionId}}",
                    "type": "{{_transactionType}}",
                    "status": "COMPLETED",
                    "amount": {{_amount}},
                    "sourceCurrency": "{{srcCurrency}}",
                    "destinationCurrency": "{{destCurrency}}",
                    "senderId": "{{senderId}}",
                    "receiverId": "receiver-{{Guid.NewGuid().ToString()[..8]}}",
                    "sourceCountry": "{{_sourceCountry}}",
                    "destinationCountry": "{{_destinationCountry}}",
                    "createdAt": "{{DateTime.UtcNow:O}}"
                }
            }
            """;

            var transaction = await TransactionService.ProcessWebhookAsync(payload);

            // Broadcast to SignalR
            if (transaction.RiskAnalysis != null)
            {
                var notification = new TransactionNotification(
                    transaction.Id,
                    transaction.ExternalId,
                    transaction.Amount,
                    transaction.SourceCountry,
                    transaction.DestinationCountry,
                    transaction.RiskAnalysis.RiskScore,
                    transaction.RiskAnalysis.RiskLevel,
                    transaction.RiskAnalysis.ReviewStatus,
                    transaction.RiskAnalysis.Explanation ?? "Risk analysis complete"
                );
                var groupName = $"tenant-{TenantContext.TenantId}";
                await HubContext.Clients.Group(groupName).SendAsync("NewTransaction", notification);
            }

            _lastResult = new SimResult
            {
                TransactionId = transaction.Id.ToString(),
                Amount = transaction.Amount,
                SourceCountry = transaction.SourceCountry,
                DestinationCountry = transaction.DestinationCountry,
                RiskScore = transaction.RiskAnalysis?.RiskScore ?? 0,
                RiskLevel = transaction.RiskAnalysis?.RiskLevel.ToString() ?? "Unknown",
                ReviewStatus = transaction.RiskAnalysis?.ReviewStatus.ToString() ?? "Pending",
                Explanation = transaction.RiskAnalysis?.Explanation ?? ""
            };
            _history.Add(_lastResult);
            Snackbar.Add("Transaction processed! Risk: " + _lastResult.RiskLevel + " (Score: " + _lastResult.RiskScore + ")",
                GetSnackbarSeverity(_lastResult.RiskLevel));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[SIMULATE] Error simulating transaction");
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
        finally { _sending = false; StateHasChanged(); }
    }

    private async Task RunScenario(decimal amount, string source, string dest, string type, string sender)
    {
        _amount = amount; _sourceCountry = source; _destinationCountry = dest;
        _transactionType = type; _senderId = sender;
        StateHasChanged();
        await SimulateTransaction();
    }

    private Color GetRiskColor(string riskLevel) => riskLevel switch
    {
        "Low" => Color.Success, "Medium" => Color.Warning,
        "High" or "Critical" => Color.Error, _ => Color.Default
    };

    private string GetRiskIcon(string riskLevel) => riskLevel switch
    {
        "Low" => Icons.Material.Filled.CheckCircle, "Medium" => Icons.Material.Filled.Warning,
        "High" => Icons.Material.Filled.GppBad, "Critical" => Icons.Material.Filled.Block,
        _ => Icons.Material.Filled.HelpOutline
    };

    private Severity GetAlertSeverity(string riskLevel) => riskLevel switch
    {
        "Low" => Severity.Success, "Medium" => Severity.Warning,
        "High" or "Critical" => Severity.Error, _ => Severity.Info
    };

    private Severity GetSnackbarSeverity(string riskLevel) => riskLevel switch
    {
        "Low" => Severity.Success, "Medium" => Severity.Warning,
        "High" or "Critical" => Severity.Error, _ => Severity.Info
    };

    private static string GetCurrencyForCountry(string country) => country switch
    {
        "NG" => "NGN", "US" => "USD", "GB" => "GBP", "KE" => "KES",
        "GH" => "GHS", "ZA" => "ZAR", "TZ" => "TZS", "UG" => "UGX",
        "CA" => "CAD", "DE" => "EUR", "KP" => "KPW", "SY" => "SYP",
        _ => "USD"
    };

    private class SimResult
    {
        public string TransactionId { get; set; } = "";
        public decimal Amount { get; set; }
        public string SourceCountry { get; set; } = "";
        public string DestinationCountry { get; set; } = "";
        public int RiskScore { get; set; }
        public string RiskLevel { get; set; } = "";
        public string ReviewStatus { get; set; } = "";
        public string Explanation { get; set; } = "";
    }
}
