@page "/billing"
@using PayGuardAI.Core.Entities
@using PayGuardAI.Core.Services
@using PayGuardAI.Data.Services
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "CanManageBilling")]
@inject BillingServiceFactory BillingFactory
@inject NavigationManager Nav
@inject IConfiguration Config
@inject ISnackbar Snackbar
@inject PayGuardAI.Core.Services.ITenantContext TenantContext
@inject IPlanFeatureService PlanFeatures

<PageTitle>Billing â€” PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-1" Style="font-weight:700">Billing</MudText>
<MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
    Manage your subscription, view usage, and update payment details.
</MudText>

@if (!_billingEnabled)
{
    <MudAlert Severity="Severity.Info">
        Billing is not yet enabled. You have full access during the beta.
        <MudLink Href="/pricing" Class="ml-2">View upcoming plans â†’</MudLink>
    </MudAlert>
}
else if (_loading)
{
    <MudProgressLinear Indeterminate="true" Class="mb-4" />
}
else
{
    @if (_success)
    {
        <MudAlert Severity="Severity.Success" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => _success = false)">
            ðŸŽ‰ Subscription activated! Welcome to PayGuard AI @(_subscription?.Plan.ToString() ?? "Pro").
        </MudAlert>
    }

    @if (!string.IsNullOrEmpty(_error))
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => _error = null)">
            @_error
        </MudAlert>
    }

    <!-- Current Plan Card -->
    <MudGrid Spacing="4" Class="mb-6">
        <MudItem xs="12" md="4">
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.overline" Color="Color.Secondary">CURRENT PLAN</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight:700">
                            @(_subscription?.Plan.ToString() ?? "Trial")
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <div class="d-flex flex-column align-end gap-1">
                            <MudChip T="string" 
                                     Color="@GetStatusColor(_subscription?.Status)"
                                     Size="Size.Small">
                                @(_subscription?.Status ?? "trialing")
                            </MudChip>
                            @if (!string.IsNullOrWhiteSpace(_subscription?.Provider))
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">
                                    @(_subscription.Provider == "flutterwave" ? "Flutterwave" : "Paystack")
                                </MudChip>
                            }
                        </div>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @if (_subscription?.TrialEndsAt != null && _subscription.Status == "trialing")
                    {
                        var daysLeft = (int)(_subscription.TrialEndsAt.Value - DateTime.UtcNow).TotalDays;
                        <MudAlert Severity="@(daysLeft <= 3 ? Severity.Warning : Severity.Info)" Dense="true" Class="mb-2">
                            @daysLeft day@(daysLeft == 1 ? "" : "s") left in trial
                        </MudAlert>
                    }
                    @if (_subscription?.PendingPlan.HasValue == true)
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                            Downgrade to <strong>@_subscription.PendingPlan.Value</strong> scheduled for
                            @_subscription.PeriodEnd.ToString("MMM d, yyyy").
                            You keep full @_subscription.Plan access until then.
                        </MudAlert>
                    }
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Billing period: @(_subscription?.PeriodStart.ToString("MMM d") ?? "â€”") â€” 
                        @(_subscription?.PeriodEnd.ToString("MMM d, yyyy") ?? "â€”")
                    </MudText>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                               OnClick="ManageSubscription" Disabled="@_portalLoading"
                               StartIcon="@Icons.Material.Filled.OpenInNew">
                        @if (_portalLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1"/>
                        }
                        Manage Subscription
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Usage Card -->
        <MudItem xs="12" md="4">
            <MudCard Elevation="2">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.overline" Color="Color.Secondary">USAGE THIS PERIOD</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight:700">
                            @(_subscription?.TransactionsThisPeriod.ToString("N0") ?? "0")
                            <MudText Typo="Typo.body1" Style="display:inline; font-weight:400"> / 
                                @(GetIncludedLabel())
                            </MudText>
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @{
                        var usagePct = GetUsagePercent();
                    }
                    <MudProgressLinear Value="@usagePct"
                                       Color="@(usagePct > 90 ? Color.Error : usagePct > 70 ? Color.Warning : Color.Primary)"
                                       Rounded="true" Size="Size.Medium" Class="mb-2" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @usagePct.ToString("0")% of included transactions used
                    </MudText>
                    @if (usagePct > 80 && _subscription?.Plan != BillingPlan.Enterprise)
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                            Approaching limit â€” <MudLink Href="/pricing">upgrade your plan</MudLink>
                        </MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Upgrade Card -->
        @if (_subscription?.Plan != BillingPlan.Enterprise)
        {
            <MudItem xs="12" md="4">
                <MudCard Elevation="2" Style="border: 1px dashed var(--mud-palette-primary);">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">UPGRADE</MudText>
                            <MudText Typo="Typo.h6">Need more transactions?</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                            Upgrade your plan to increase your transaction limit and unlock advanced features.
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   Href="/pricing" StartIcon="@Icons.Material.Filled.ArrowUpward">
                            View Plans
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    <!-- Plan Features -->
    <MudText Typo="Typo.h6" Class="mb-3">Your Plan Includes</MudText>
    <MudGrid Spacing="2" Class="mb-6">
        @foreach (var feature in GetCurrentPlanFeatures())
        {
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="0" Class="pa-3 d-flex align-center"
                          Style="background: var(--mud-palette-surface);">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Class="mr-2" Size="Size.Small"/>
                    <MudText Typo="Typo.body2">@feature</MudText>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>

    <!-- Plan Limits -->
    <MudText Typo="Typo.h6" Class="mb-3">Plan Limits</MudText>
    <MudGrid Spacing="2" Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="1" Class="pa-4 text-center">
                <MudText Typo="Typo.overline" Color="Color.Secondary">TEAM MEMBERS</MudText>
                <MudText Typo="Typo.h5" Style="font-weight:700">
                    @(_maxTeamMembers == int.MaxValue ? "âˆž" : _maxTeamMembers.ToString())
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="1" Class="pa-4 text-center">
                <MudText Typo="Typo.overline" Color="Color.Secondary">API KEYS</MudText>
                <MudText Typo="Typo.h5" Style="font-weight:700">
                    @(_maxApiKeys == int.MaxValue ? "âˆž" : _maxApiKeys.ToString())
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="1" Class="pa-4 text-center">
                <MudText Typo="Typo.overline" Color="Color.Secondary">WEBHOOK ENDPOINTS</MudText>
                <MudText Typo="Typo.h5" Style="font-weight:700">
                    @(_maxWebhooks == int.MaxValue ? "âˆž" : _maxWebhooks == 0 ? "â€”" : _maxWebhooks.ToString())
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="1" Class="pa-4 text-center">
                <MudText Typo="Typo.overline" Color="Color.Secondary">TRANSACTIONS</MudText>
                <MudText Typo="Typo.h5" Style="font-weight:700">
                    @GetIncludedLabel()
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">/month</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private TenantSubscription? _subscription;
    private bool _loading = true;
    private bool _portalLoading;
    private bool _billingEnabled;
    private bool _success;
    private IBillingService? _activeBillingService;
    private int _maxTeamMembers;
    private int _maxApiKeys;
    private int _maxWebhooks;

    private string? _error;

    [SupplyParameterFromQuery(Name = "success")]
    public bool SuccessParam { get; set; }

    /// <summary>Paystack appends trxref after successful checkout redirect.</summary>
    [SupplyParameterFromQuery(Name = "trxref")]
    public string? TrxRef { get; set; }

    /// <summary>Paystack appends reference after successful checkout redirect.</summary>
    [SupplyParameterFromQuery(Name = "reference")]
    public string? Reference { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _billingEnabled = bool.TryParse(Config["FeatureFlags:BillingEnabled"], out var b) && b;

        if (_billingEnabled)
        {
            _activeBillingService = BillingFactory.GetDefault();

            // Step 1: If redirected from Paystack, verify the payment and activate subscription
            var reference = Reference ?? TrxRef;
            if (!string.IsNullOrEmpty(reference))
            {
                try
                {
                    var verified = await _activeBillingService.VerifyCheckoutAsync(
                        TenantContext.TenantId, reference);
                    if (verified != null && verified.Status == "active")
                    {
                        _subscription = verified;
                        _success = true;
                    }
                    else
                    {
                        _error = "Payment verification returned no active subscription. " +
                                 "Your payment was received â€” the subscription will activate shortly via webhook.";
                    }
                }
                catch (Exception ex)
                {
                    _error = $"Payment verification error: {ex.Message}. " +
                             "Your payment was received â€” the subscription will activate shortly via webhook.";
                }
            }

            // Step 2: Load subscription from DB (may already be set from verify above)
            if (_subscription == null)
            {
                try
                {
                    _subscription = await _activeBillingService.GetSubscriptionAsync(TenantContext.TenantId);
                }
                catch { /* no subscription yet is fine */ }
            }

            // Step 3: If subscription uses a specific provider, switch to that service
            if (_subscription != null && !string.IsNullOrWhiteSpace(_subscription.Provider))
            {
                try { _activeBillingService = BillingFactory.GetProvider(_subscription.Provider); }
                catch { /* keep default */ }
            }

            // Fallback: detect success from query param
            if (!_success)
                _success = SuccessParam;

            // Get plan limits
            var currentPlan = _subscription?.Plan ?? BillingPlan.Trial;
            _maxTeamMembers = PlanFeatures.GetMaxTeamMembers(currentPlan);
            _maxApiKeys = PlanFeatures.GetMaxApiKeys(currentPlan);
            _maxWebhooks = PlanFeatures.GetMaxWebhookEndpoints(currentPlan);
        }

        _loading = false;
    }

    private async Task ManageSubscription()
    {
        if (_subscription == null || _activeBillingService == null)
        {
            Snackbar.Add("No active subscription found. Please subscribe first.", Severity.Warning);
            return;
        }

        _portalLoading = true;
        try
        {
            var manageUrl = await _activeBillingService.GetManageSubscriptionUrlAsync(TenantContext.TenantId);
            Nav.NavigateTo(manageUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Could not open subscription management. " + ex.Message, Severity.Error);
        }
        finally
        {
            _portalLoading = false;
        }
    }

    private double GetUsagePercent()
    {
        if (_subscription == null) return 0;
        if (_subscription.Plan == BillingPlan.Enterprise) return 0;
        var limit = _subscription.IncludedTransactions;
        if (limit <= 0) return 0;
        return Math.Min(100, (_subscription.TransactionsThisPeriod / (double)limit) * 100);
    }

    private string GetIncludedLabel() =>
        _subscription?.Plan == BillingPlan.Enterprise ? "âˆž" :
        _subscription?.IncludedTransactions.ToString("N0") ?? "1,000";

    private Color GetStatusColor(string? status) => status switch
    {
        "active"   => Color.Success,
        "trialing" => Color.Info,
        "past_due" => Color.Warning,
        "canceled" => Color.Error,
        "pending"  => Color.Default,
        _ => Color.Default
    };

    private string[] GetCurrentPlanFeatures()
    {
        var billingService = _activeBillingService ?? BillingFactory.GetDefault();
        var plan = billingService.GetPlans()
            .FirstOrDefault(p => p.Plan == (_subscription?.Plan ?? BillingPlan.Trial));
        return plan?.Features ?? ["Real-time risk scoring", "HITL review queue", "14-day free trial"];
    }
}
