@page "/admin/settings"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "CanManageSettings")]
@inject PayGuardAI.Core.Services.IAdminService AdminService
@inject ISnackbar Snackbar
@inject PayGuardAI.Web.Services.CurrentUserService CurrentUser
@inject PayGuardAI.Core.Services.ITenantContext TenantContext

<PageTitle>Organization Settings — PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
    Organization Settings
</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_settings != null)
{
    <MudGrid Spacing="4">
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-6" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">General</MudText>
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_settings.OrganizationName"
                                  Label="Organization Name" Variant="Variant.Outlined"
                                  Placeholder="Acme Fintech Ltd" />
                    <MudTextField @bind-Value="_settings.SupportEmail"
                                  Label="Support Email" Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Placeholder="support@acme.com" />
                    <MudTextField @bind-Value="_settings.LogoUrl"
                                  Label="Logo URL" Variant="Variant.Outlined"
                                  Placeholder="https://example.com/logo.png" />
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="string" @bind-Value="_settings.Timezone"
                                       Label="Timezone" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("UTC")">UTC</MudSelectItem>
                                <MudSelectItem Value="@("Africa/Lagos")">Africa/Lagos (WAT)</MudSelectItem>
                                <MudSelectItem Value="@("Africa/Nairobi")">Africa/Nairobi (EAT)</MudSelectItem>
                                <MudSelectItem Value="@("Africa/Johannesburg")">Africa/Johannesburg (SAST)</MudSelectItem>
                                <MudSelectItem Value="@("America/New_York")">America/New York (EST)</MudSelectItem>
                                <MudSelectItem Value="@("Europe/London")">Europe/London (GMT)</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="string" @bind-Value="_settings.DefaultCurrency"
                                       Label="Default Currency" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("USD")">USD — US Dollar</MudSelectItem>
                                <MudSelectItem Value="@("NGN")">NGN — Nigerian Naira</MudSelectItem>
                                <MudSelectItem Value="@("KES")">KES — Kenyan Shilling</MudSelectItem>
                                <MudSelectItem Value="@("GBP")">GBP — British Pound</MudSelectItem>
                                <MudSelectItem Value="@("EUR")">EUR — Euro</MudSelectItem>
                                <MudSelectItem Value="@("ZAR")">ZAR — South African Rand</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Class="pa-6" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Risk Thresholds</MudText>
                <MudStack Spacing="3">
                    <MudNumericField T="int" @bind-Value="_settings.AutoApproveThreshold"
                                     Label="Auto-Approve Below Score"
                                     Variant="Variant.Outlined"
                                     Min="0" Max="100"
                                     HelperText="Transactions below this score are auto-approved" />
                    <MudNumericField T="int" @bind-Value="_settings.AutoRejectThreshold"
                                     Label="Auto-Reject Above Score"
                                     Variant="Variant.Outlined"
                                     Min="0" Max="100"
                                     HelperText="Transactions above this score are auto-rejected" />
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                        Scores between @_settings.AutoApproveThreshold and @_settings.AutoRejectThreshold 
                        go to the HITL review queue.
                    </MudAlert>
                </MudStack>
            </MudPaper>

            <MudPaper Class="pa-6 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-1" />
                    High-Risk Countries (Sanctions List)
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    ISO 3166-1 alpha-2 country codes used by the HIGH_RISK_CORRIDOR rule.
                    Transactions involving these countries are flagged as critical risk.
                </MudText>
                <MudTextField @bind-Value="_settings.HighRiskCountries"
                              Label="Sanctioned Country Codes" Variant="Variant.Outlined"
                              Placeholder="IR,KP,SY,YE,VE,CU,MM,AF"
                              HelperText="Comma-separated ISO codes. Default: IR, KP, SY, YE, VE, CU, MM, AF (OFAC/FATF)" />
                <MudStack Row="true" Spacing="1" Class="mt-2 flex-wrap">
                    @foreach (var countryCode in GetHighRiskCodes())
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined">@countryCode</MudChip>
                    }
                </MudStack>
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                    <strong>@GetHighRiskCodes().Length</strong> countries on your sanctions list.
                    Changes take effect on the next transaction scored.
                    This also affects the ML model's corridor-risk feature.
                </MudAlert>
            </MudPaper>

            <MudPaper Class="pa-6 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-2">
                    <MudIcon Icon="@Icons.Custom.Brands.GitHub" Class="mr-1" />
                    Slack Alerts
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    Receive real-time alerts in your Slack channel when high-risk transactions are detected.
                </MudText>
                <MudTextField @bind-Value="_settings.SlackWebhookUrl"
                              Label="Slack Webhook URL" Variant="Variant.Outlined"
                              Placeholder="https://hooks.slack.com/services/T.../B.../..."
                              HelperText="Create one at api.slack.com → Incoming Webhooks"
                              InputType="InputType.Url" />
                @if (!string.IsNullOrWhiteSpace(_settings.SlackWebhookUrl))
                {
                    <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-1" />
                        Slack alerts are configured for your organization.
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                        No webhook URL set — alerts will use the platform default (if configured).
                    </MudAlert>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="SaveSettings" Disabled="@_saving"
                       Size="Size.Large">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Save Settings
            </MudButton>
        </MudItem>
    </MudGrid>

}

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Class="mt-4">@_error</MudAlert>
}
else if (!_loading && _settings == null)
{
    <MudAlert Severity="Severity.Warning" Class="mt-4">
        Unable to load organization settings. Please try refreshing the page.
    </MudAlert>
}

@code {
    private PayGuardAI.Core.Entities.OrganizationSettings? _settings;
    private bool _loading = true;
    private bool _saving;
    private string _error = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await AdminService.GetOrCreateSettingsAsync(TenantContext.TenantId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveSettings()
    {
        if (_settings == null) return;
        _saving = true;
        _error = string.Empty;

        try
        {
            await AdminService.UpdateSettingsAsync(_settings, CurrentUser.UserName);
            Snackbar.Add("Settings saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private string[] GetHighRiskCodes()
    {
        if (_settings == null || string.IsNullOrWhiteSpace(_settings.HighRiskCountries))
            return Array.Empty<string>();

        return _settings.HighRiskCountries
            .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    }
}
