@page "/reports"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDbContextFactory<PayGuardAI.Data.ApplicationDbContext> DbFactory
@inject PayGuardAI.Core.Services.ITenantContext TenantContext
@inject IReviewService ReviewService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IFraudSavingsService FraudSavingsService
@using Microsoft.EntityFrameworkCore

<PageTitle>Compliance Reports - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2" />
    Compliance Reports
</MudText>

<MudGrid>
    <!-- Report Filters -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="From Date" @bind-Date="_fromDate" 
                                   Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="To Date" @bind-Date="_toDate" 
                                   Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               FullWidth="true" Class="mt-4"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="@GenerateReport">
                        Generate Report
                    </MudButton>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" 
                               FullWidth="true" Class="mt-4"
                               StartIcon="@Icons.Material.Filled.Download"
                               OnClick="@ExportReport">
                        Export CSV
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    @* ── Additional Compliance Exports ────────────────────────────── *@
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle1" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.FileDownload" Class="mr-1" />
                Compliance Export Pack
            </MudText>
            <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                <MudButton Variant="Variant.Outlined" Color="Color.Info"
                           StartIcon="@Icons.Material.Filled.History"
                           OnClick="@ExportAuditLog" Disabled="@_exportingAudit">
                    @if (_exportingAudit) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" /> }
                    Audit Trail CSV
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Tertiary"
                           StartIcon="@Icons.Material.Filled.People"
                           OnClick="@ExportUserAccess" Disabled="@_exportingAccess">
                    @if (_exportingAccess) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" /> }
                    User Access Report
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                           StartIcon="@Icons.Material.Filled.Gavel"
                           OnClick="@ExportRuleChanges" Disabled="@_exportingRules">
                    @if (_exportingRules) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" /> }
                    Rule Change Log
                </MudButton>
            </MudStack>
            <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                Download compliance reports for the selected date range. These exports include full audit trails suitable for regulatory submissions.
            </MudText>
        </MudPaper>
    </MudItem>

    @if (_reportGenerated)
    {
        <!-- Summary Statistics -->
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Primary">Total Analyzed</MudText>
                <MudText Typo="Typo.h3">@_totalTransactions</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Success">Approved</MudText>
                <MudText Typo="Typo.h3">@_approvedCount</MudText>
                <MudText Typo="Typo.caption">@GetPercentage(_approvedCount)%</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Error">Rejected</MudText>
                <MudText Typo="Typo.h3">@_rejectedCount</MudText>
                <MudText Typo="Typo.caption">@GetPercentage(_rejectedCount)%</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Warning">High Risk Flagged</MudText>
                <MudText Typo="Typo.h3">@_highRiskCount</MudText>
                <MudText Typo="Typo.caption">@GetPercentage(_highRiskCount)%</MudText>
            </MudPaper>
        </MudItem>

        <!-- Risk Distribution Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.PieChart" Class="mr-2" />
                    Risk Level Distribution
                </MudText>
                <div style="max-width: 300px; margin: 0 auto;">
                    <MudChart ChartType="ChartType.Donut" 
                              InputData="@_riskChartData" 
                              InputLabels="@_riskChartLabels"
                              Width="100%" Height="300px" />
                </div>
                <MudStack Row="true" Justify="Justify.Center" Class="mt-3" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var dist in _riskDistribution.Where(d => d.Count > 0))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetRiskColor(dist.Level)">
                            @dist.Level: @dist.Count (@dist.Percentage.ToString("F0")%)
                        </MudChip>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Review Status Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="mr-2" />
                    Review Status Breakdown
                </MudText>
                @if (_reviewChartSeries.Any() && _reviewChartLabels.Any())
                {
                    <div style="height: 280px;">
                        <MudChart ChartType="ChartType.Bar" 
                                  ChartSeries="@_reviewChartSeries"
                                  XAxisLabels="@_reviewChartLabels"
                                  Width="100%" Height="250px"
                                  ChartOptions="@_barOptions" />
                    </div>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No review data available</MudAlert>
                }
                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle2">Response Times</MudText>
                <MudStack Row="true" Class="mt-2" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var activity in _reviewActivity.Where(a => a.AvgResponseTime != "N/A"))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(activity.Status)">
                            @activity.Status: @activity.AvgResponseTime
                        </MudChip>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Top Risk Factors -->
        <!-- Top Risk Factors Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-2" />
                    Top Risk Factors
                </MudText>
                @if (_factorChartSeries.Any() && _factorChartLabels.Any())
                {
                    <div style="height: 280px;">
                        <MudChart ChartType="ChartType.Bar" 
                                  ChartSeries="@_factorChartSeries"
                                  XAxisLabels="@_factorChartLabels"
                                  Width="100%" Height="250px"
                                  ChartOptions="@_barOptions" />
                    </div>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No risk factors triggered in this period</MudAlert>
                }
            </MudPaper>
        </MudItem>
        
        <!-- Top Corridors -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Flight" Class="mr-2" />
                    Top Transaction Corridors
                </MudText>
                @if (_topCorridors.Any())
                {
                    <MudSimpleTable Dense="true">
                        <thead>
                            <tr>
                                <th>Corridor</th>
                                <th>Count</th>
                                <th>Volume</th>
                                <th>Avg Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var corridor in _topCorridors)
                            {
                                <tr>
                                    <td>
                                        <MudStack Row="true" AlignItems="AlignItems.Center">
                                            <MudText>@corridor.Source</MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                            <MudText>@corridor.Destination</MudText>
                                        </MudStack>
                                    </td>
                                    <td>@corridor.Count</td>
                                    <td>@corridor.Volume.ToString("N0")</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Color="@(corridor.AvgRisk > 50 ? Color.Error : corridor.AvgRisk > 25 ? Color.Warning : Color.Success)">
                                            @corridor.AvgRisk.ToString("F0")
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No corridor data in this period</MudAlert>
                }
            </MudPaper>
        </MudItem>

        <!-- Compliance Statement -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2"
                      Style="border-left: 4px solid var(--mud-palette-success);">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Success" Class="mr-2" />
                    Fraud Savings by Rule
                </MudText>
                @if (_ruleSavings.Any())
                {
                    <MudSimpleTable Dense="true">
                        <thead>
                            <tr>
                                <th>Rule</th>
                                <th>Category</th>
                                <th>Blocked</th>
                                <th>Amount Saved</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var rule in _ruleSavings.Take(8))
                            {
                                <tr>
                                    <td>@(rule.RuleName.Length > 25 ? rule.RuleName[..22] + "..." : rule.RuleName)</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="@GetCategoryColor(rule.Category)">
                                            @rule.Category
                                        </MudChip>
                                    </td>
                                    <td>@rule.TransactionCount</td>
                                    <td Style="font-weight: 600; color: var(--mud-palette-success);">
                                        $@rule.AmountSaved.ToString("N0")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                    <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                        Total: $@_ruleSavings.Sum(r => r.AmountSaved).ToString("N0") saved across
                        @_ruleSavings.Sum(r => r.TransactionCount) blocked transactions
                    </MudText>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No rejected transactions yet — savings will appear here as fraud is blocked.</MudAlert>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Verified" Color="Color.Success" Class="mr-2" />
                    Compliance Statement
                </MudText>
                <MudText>
                    This report was generated on <strong>@DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss")</strong> UTC 
                    for the period <strong>@_fromDate?.ToString("yyyy-MM-dd")</strong> to <strong>@_toDate?.ToString("yyyy-MM-dd")</strong>.
                </MudText>
                <MudText Class="mt-2">
                    All transactions have been analyzed using the PayGuard AI risk scoring engine in compliance with 
                    Central Bank of Nigeria (CBN) Anti-Money Laundering (AML) guidelines and international FATF recommendations.
                </MudText>
                <MudText Class="mt-2" Color="Color.Primary">
                    <strong>Key Compliance Metrics:</strong>
                </MudText>
                <MudList T="string" Dense="true" Class="mt-1">
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                        @_totalTransactions transactions analyzed with @_highRiskCount (@GetPercentage(_highRiskCount)%) flagged for review
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                        @_approvedCount transactions approved, @_rejectedCount rejected
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                        Average risk score: @_avgRiskScore.ToString("F1")
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success" IconSize="Size.Small">
                        Human-in-the-Loop review coverage: 100% of flagged transactions
                    </MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>
    }
</MudGrid>

@code {
    private DateTime? _fromDate = DateTime.UtcNow.Date.AddDays(-7);
    private DateTime? _toDate = DateTime.UtcNow.Date;
    private bool _reportGenerated = false;

    // Stats
    private int _totalTransactions;
    private int _approvedCount;
    private int _rejectedCount;
    private int _highRiskCount;
    private double _avgRiskScore;

    private List<RiskDistribution> _riskDistribution = new();
    private List<ReviewActivity> _reviewActivity = new();
    private List<TopRiskFactor> _topRiskFactors = new();
    private List<CorridorSummary> _topCorridors = new();
    private List<RuleSavingsInfo> _ruleSavings = new();
    
    // Chart data
    private double[] _riskChartData = Array.Empty<double>();
    private string[] _riskChartLabels = Array.Empty<string>();
    private List<ChartSeries> _reviewChartSeries = new();
    private string[] _reviewChartLabels = Array.Empty<string>();
    private List<ChartSeries> _factorChartSeries = new();
    private string[] _factorChartLabels = Array.Empty<string>();
    
    private ChartOptions _barOptions = new() { YAxisTicks = 5, MaxNumYAxisTicks = 10 };

    private string GetPercentage(int count)
    {
        if (_totalTransactions == 0) return "0.0";
        return (count * 100.0 / _totalTransactions).ToString("F1");
    }

    protected override async Task OnInitializedAsync()
    {
        await GenerateReport();
    }

    private async Task GenerateReport()
    {
        var from = _fromDate ?? DateTime.UtcNow.Date.AddDays(-30);
        var to = (_toDate ?? DateTime.UtcNow.Date).AddDays(1); // Include full day

        await using var db = await DbFactory.CreateDbContextAsync();
        db.SetTenantId(TenantContext.TenantId);

        var analyses = await db.RiskAnalyses
            .Include(r => r.Transaction)
            .Include(r => r.RiskFactors)
            .Where(r => r.AnalyzedAt >= from && r.AnalyzedAt < to)
            .ToListAsync();

        _totalTransactions = analyses.Count;
        _approvedCount = analyses.Count(a => a.ReviewStatus == ReviewStatus.Approved || a.ReviewStatus == ReviewStatus.AutoApproved);
        _rejectedCount = analyses.Count(a => a.ReviewStatus == ReviewStatus.Rejected);
        _highRiskCount = analyses.Count(a => a.RiskLevel >= RiskLevel.High);
        _avgRiskScore = analyses.Any() ? analyses.Average(a => a.RiskScore) : 0;

        // Risk distribution
        _riskDistribution = Enum.GetValues<RiskLevel>()
            .Select(level => new RiskDistribution
            {
                Level = level,
                Count = analyses.Count(a => a.RiskLevel == level),
                Percentage = _totalTransactions > 0 
                    ? analyses.Count(a => a.RiskLevel == level) * 100.0 / _totalTransactions 
                    : 0
            })
            .ToList();

        // Review activity
        _reviewActivity = Enum.GetValues<ReviewStatus>()
            .Select(status => new ReviewActivity
            {
                Status = status,
                Count = analyses.Count(a => a.ReviewStatus == status),
                AvgResponseTime = CalculateAvgResponseTime(analyses.Where(a => a.ReviewStatus == status))
            })
            .Where(a => a.Count > 0)
            .ToList();
        
        // Prepare chart data
        _riskChartData = _riskDistribution.Select(d => (double)d.Count).ToArray();
        _riskChartLabels = _riskDistribution.Select(d => d.Level.ToString()).ToArray();
        
        // Review status bar chart
        _reviewChartLabels = _reviewActivity.Select(a => a.Status.ToString()).ToArray();
        _reviewChartSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Transactions", Data = _reviewActivity.Select(a => (double)a.Count).ToArray() }
        };

        // Top risk factors
        var allFactors = analyses.SelectMany(a => a.RiskFactors).ToList();
        _topRiskFactors = allFactors
            .GroupBy(f => f.RuleName)
            .Select(g => new TopRiskFactor
            {
                RuleName = g.Key,
                Category = g.First().Category,
                TriggerCount = g.Count(),
                AvgScoreImpact = (int)g.Average(f => f.ScoreContribution)
            })
            .OrderByDescending(f => f.TriggerCount)
            .Take(6)
            .ToList();
        
        // Factor chart data
        _factorChartLabels = _topRiskFactors.Select(f => f.RuleName.Length > 15 ? f.RuleName[..12] + "..." : f.RuleName).ToArray();
        _factorChartSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Times Triggered", Data = _topRiskFactors.Select(f => (double)f.TriggerCount).ToArray() }
        };
        
        // Top corridors
        _topCorridors = analyses
            .Where(a => a.Transaction != null)
            .GroupBy(a => new { a.Transaction!.SourceCountry, a.Transaction.DestinationCountry })
            .Select(g => new CorridorSummary
            {
                Source = g.Key.SourceCountry,
                Destination = g.Key.DestinationCountry,
                Count = g.Count(),
                Volume = g.Sum(a => a.Transaction!.Amount),
                AvgRisk = g.Average(a => a.RiskScore)
            })
            .OrderByDescending(c => c.Count)
            .Take(5)
            .ToList();

        _reportGenerated = true;

        // Load fraud savings breakdown by rule (non-fatal)
        try { _ruleSavings = await FraudSavingsService.GetSavingsByRuleAsync(); }
        catch { _ruleSavings = new List<RuleSavingsInfo>(); }
    }

    private string CalculateAvgResponseTime(IEnumerable<RiskAnalysis> analyses)
    {
        var reviewed = analyses.Where(a => a.ReviewedAt.HasValue).ToList();
        if (!reviewed.Any()) return "N/A";
        
        var avgMinutes = reviewed.Average(a => (a.ReviewedAt!.Value - a.AnalyzedAt).TotalMinutes);
        return avgMinutes < 60 ? $"{avgMinutes:F0} min" : $"{avgMinutes / 60:F1} hrs";
    }

    private async Task ExportReport()
    {
        if (!_reportGenerated)
        {
            Snackbar.Add("Generate a report first before exporting.", Severity.Warning);
            return;
        }

        try
        {
            var from = _fromDate ?? DateTime.UtcNow.Date.AddDays(-30);
            var to = (_toDate ?? DateTime.UtcNow.Date).AddDays(1);

            await using var db = await DbFactory.CreateDbContextAsync();
            db.SetTenantId(TenantContext.TenantId);

            var analyses = await db.RiskAnalyses
                .Include(r => r.Transaction)
                .Include(r => r.RiskFactors)
                .Where(r => r.AnalyzedAt >= from && r.AnalyzedAt < to)
                .OrderByDescending(r => r.AnalyzedAt)
                .ToListAsync();

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("Transaction ID,Date,Amount,Currency,Source,Destination,Risk Score,Risk Level,Review Status,Reviewed By,Review Time");

            foreach (var a in analyses)
            {
                var t = a.Transaction;
                var reviewTime = a.ReviewedAt.HasValue ? (a.ReviewedAt.Value - a.AnalyzedAt).TotalMinutes.ToString("F0") + " min" : "";
                sb.AppendLine(string.Join(",",
                    CsvEscape(t?.ExternalId ?? ""),
                    CsvEscape(a.AnalyzedAt.ToString("yyyy-MM-dd HH:mm:ss")),
                    t?.Amount.ToString("F2") ?? "0",
                    CsvEscape(t?.SourceCurrency ?? ""),
                    CsvEscape(t?.SourceCountry ?? ""),
                    CsvEscape(t?.DestinationCountry ?? ""),
                    a.RiskScore.ToString(),
                    a.RiskLevel.ToString(),
                    a.ReviewStatus.ToString(),
                    CsvEscape(a.ReviewedBy ?? ""),
                    CsvEscape(reviewTime)
                ));
            }

            var bytes = System.Text.Encoding.UTF8.GetBytes(sb.ToString());
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"payguard-compliance-report-{from:yyyyMMdd}-{to.AddDays(-1):yyyyMMdd}.csv";
            var script = "(function() { var link = document.createElement('a'); link.download = '"
                + fileName + "'; link.href = 'data:text/csv;base64," + base64 + "'; link.click(); })()";
            await JS.InvokeVoidAsync("eval", script);

            Snackbar.Add($"Exported {analyses.Count} records to CSV", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

// ── Additional compliance export state ─────────────────────────────
    private bool _exportingAudit;
    private bool _exportingAccess;
    private bool _exportingRules;

    private async Task ExportAuditLog()
    {
        _exportingAudit = true;
        try
        {
            var from = _fromDate ?? DateTime.UtcNow.Date.AddDays(-30);
            var to = (_toDate ?? DateTime.UtcNow.Date).AddDays(1);

            await using var db = await DbFactory.CreateDbContextAsync();
            db.SetTenantId(TenantContext.TenantId);

            var logs = await db.AuditLogs
                .Where(a => a.CreatedAt >= from && a.CreatedAt < to)
                .OrderByDescending(a => a.CreatedAt)
                .ToListAsync();

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("Timestamp,Action,Entity Type,Entity ID,Performed By,IP Address,Notes");
            foreach (var log in logs)
            {
                sb.AppendLine(string.Join(",",
                    CsvEscape(log.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")),
                    CsvEscape(log.Action),
                    CsvEscape(log.EntityType),
                    CsvEscape(log.EntityId),
                    CsvEscape(log.PerformedBy),
                    CsvEscape(log.IpAddress ?? ""),
                    CsvEscape(log.Notes ?? "")
                ));
            }

            await DownloadCsv(sb.ToString(), $"payguard-audit-log-{from:yyyyMMdd}-{to.AddDays(-1):yyyyMMdd}.csv");
            Snackbar.Add($"Exported {logs.Count} audit log entries", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Audit export failed: {ex.Message}", Severity.Error);
        }
        finally { _exportingAudit = false; }
    }

    private async Task ExportUserAccess()
    {
        _exportingAccess = true;
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            db.SetTenantId(TenantContext.TenantId);

            var members = await db.TeamMembers
                .OrderBy(m => m.Email)
                .ToListAsync();

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("Email,Display Name,Role,Status,Last Login,Invited At,Created At");
            foreach (var m in members)
            {
                sb.AppendLine(string.Join(",",
                    CsvEscape(m.Email),
                    CsvEscape(m.DisplayName),
                    CsvEscape(m.Role),
                    CsvEscape(m.Status),
                    CsvEscape(m.LastLoginAt?.ToString("yyyy-MM-dd HH:mm:ss") ?? "Never"),
                    CsvEscape(m.InvitedAt.ToString("yyyy-MM-dd HH:mm:ss")),
                    CsvEscape(m.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss"))
                ));
            }

            await DownloadCsv(sb.ToString(), $"payguard-user-access-report-{DateTime.UtcNow:yyyyMMdd}.csv");
            Snackbar.Add($"Exported {members.Count} user access records", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"User access export failed: {ex.Message}", Severity.Error);
        }
        finally { _exportingAccess = false; }
    }

    private async Task ExportRuleChanges()
    {
        _exportingRules = true;
        try
        {
            var from = _fromDate ?? DateTime.UtcNow.Date.AddDays(-30);
            var to = (_toDate ?? DateTime.UtcNow.Date).AddDays(1);

            await using var db = await DbFactory.CreateDbContextAsync();
            db.SetTenantId(TenantContext.TenantId);

            var versions = await db.RuleVersions
                .Where(v => v.CreatedAt >= from && v.CreatedAt < to)
                .OrderByDescending(v => v.CreatedAt)
                .ToListAsync();

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("Timestamp,Rule Name,Entity Type,Version #,Changed By,Description");
            foreach (var v in versions)
            {
                sb.AppendLine(string.Join(",",
                    CsvEscape(v.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")),
                    CsvEscape(v.RuleName ?? ""),
                    CsvEscape(v.EntityType),
                    v.VersionNumber.ToString(),
                    CsvEscape(v.ChangedBy),
                    CsvEscape(v.ChangeDescription ?? "")
                ));
            }

            await DownloadCsv(sb.ToString(), $"payguard-rule-changes-{from:yyyyMMdd}-{to.AddDays(-1):yyyyMMdd}.csv");
            Snackbar.Add($"Exported {versions.Count} rule change records", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Rule change export failed: {ex.Message}", Severity.Error);
        }
        finally { _exportingRules = false; }
    }

    private async Task DownloadCsv(string csvContent, string fileName)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(csvContent);
        var base64 = Convert.ToBase64String(bytes);
        var script = "(function() { var link = document.createElement('a'); link.download = '"
            + fileName + "'; link.href = 'data:text/csv;base64," + base64 + "'; link.click(); })()";
        await JS.InvokeVoidAsync("eval", script);
    }

    private string CsvEscape(string value)
    {
        if (value.Contains(',') || value.Contains('"') || value.Contains('\n')
            || value.Contains('-') || value.Contains('/') || value.Contains(':'))
            return $"\"{value.Replace("\"", "\"\"")}\""; 
        return value;
    }

    private Color GetRiskColor(RiskLevel level) => level switch
    {
        RiskLevel.Low => Color.Success,
        RiskLevel.Medium => Color.Warning,
        RiskLevel.High => Color.Error,
        RiskLevel.Critical => Color.Dark,
        _ => Color.Default
    };

    private Color GetStatusColor(ReviewStatus status) => status switch
    {
        ReviewStatus.Pending => Color.Warning,
        ReviewStatus.Approved or ReviewStatus.AutoApproved => Color.Success,
        ReviewStatus.Rejected => Color.Error,
        ReviewStatus.Escalated => Color.Info,
        _ => Color.Default
    };

    private Color GetCategoryColor(string category) => category switch
    {
        "Amount" => Color.Primary,
        "Velocity" => Color.Secondary,
        "Geography" => Color.Error,
        "Pattern" => Color.Info,
        _ => Color.Default
    };

    private class RiskDistribution
    {
        public RiskLevel Level { get; set; }
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    private class ReviewActivity
    {
        public ReviewStatus Status { get; set; }
        public int Count { get; set; }
        public string AvgResponseTime { get; set; } = "";
    }

    private class TopRiskFactor
    {
        public string RuleName { get; set; } = "";
        public string Category { get; set; } = "";
        public int TriggerCount { get; set; }
        public int AvgScoreImpact { get; set; }
    }
    
    private class CorridorSummary
    {
        public string Source { get; set; } = "";
        public string Destination { get; set; } = "";
        public int Count { get; set; }
        public decimal Volume { get; set; }
        public double AvgRisk { get; set; }
    }
}
