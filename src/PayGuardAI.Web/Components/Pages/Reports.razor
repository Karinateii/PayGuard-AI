@page "/reports"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject PayGuardAI.Data.ApplicationDbContext DbContext
@inject IReviewService ReviewService
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore

<PageTitle>Compliance Reports - PayGuard AI</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2" />
    Compliance Reports
</MudText>

<MudGrid>
    <!-- Report Filters -->
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="From Date" @bind-Date="_fromDate" 
                                   Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Label="To Date" @bind-Date="_toDate" 
                                   Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               FullWidth="true" Class="mt-4"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="@GenerateReport">
                        Generate Report
                    </MudButton>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" 
                               FullWidth="true" Class="mt-4"
                               StartIcon="@Icons.Material.Filled.Download"
                               OnClick="@ExportReport">
                        Export CSV
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    @if (_reportGenerated)
    {
        <!-- Summary Statistics -->
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Primary">Total Analyzed</MudText>
                <MudText Typo="Typo.h3">@_totalTransactions</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Success">Approved</MudText>
                <MudText Typo="Typo.h3">@_approvedCount</MudText>
                <MudText Typo="Typo.caption">@GetPercentage(_approvedCount)%</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Error">Rejected</MudText>
                <MudText Typo="Typo.h3">@_rejectedCount</MudText>
                <MudText Typo="Typo.caption">@GetPercentage(_rejectedCount)%</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Color="Color.Warning">High Risk Flagged</MudText>
                <MudText Typo="Typo.h3">@_highRiskCount</MudText>
                <MudText Typo="Typo.caption">@GetPercentage(_highRiskCount)%</MudText>
            </MudPaper>
        </MudItem>

        <!-- Risk Distribution Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.PieChart" Class="mr-2" />
                    Risk Level Distribution
                </MudText>
                <div style="max-width: 300px; margin: 0 auto;">
                    <MudChart ChartType="ChartType.Donut" 
                              InputData="@_riskChartData" 
                              InputLabels="@_riskChartLabels"
                              Width="100%" Height="300px" />
                </div>
                <MudStack Row="true" Justify="Justify.Center" Class="mt-3" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var dist in _riskDistribution.Where(d => d.Count > 0))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetRiskColor(dist.Level)">
                            @dist.Level: @dist.Count (@dist.Percentage.ToString("F0")%)
                        </MudChip>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Review Status Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="mr-2" />
                    Review Status Breakdown
                </MudText>
                @if (_reviewChartSeries.Any() && _reviewChartLabels.Any())
                {
                    <div style="height: 280px;">
                        <MudChart ChartType="ChartType.Bar" 
                                  ChartSeries="@_reviewChartSeries"
                                  XAxisLabels="@_reviewChartLabels"
                                  Width="100%" Height="250px"
                                  ChartOptions="@_barOptions" />
                    </div>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No review data available</MudAlert>
                }
                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle2">Response Times</MudText>
                <MudStack Row="true" Class="mt-2" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var activity in _reviewActivity.Where(a => a.AvgResponseTime != "N/A"))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(activity.Status)">
                            @activity.Status: @activity.AvgResponseTime
                        </MudChip>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Top Risk Factors -->
        <!-- Top Risk Factors Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-2" />
                    Top Risk Factors
                </MudText>
                @if (_factorChartSeries.Any() && _factorChartLabels.Any())
                {
                    <div style="height: 280px;">
                        <MudChart ChartType="ChartType.Bar" 
                                  ChartSeries="@_factorChartSeries"
                                  XAxisLabels="@_factorChartLabels"
                                  Width="100%" Height="250px"
                                  ChartOptions="@_barOptions" />
                    </div>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No risk factors triggered in this period</MudAlert>
                }
            </MudPaper>
        </MudItem>
        
        <!-- Top Corridors -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Flight" Class="mr-2" />
                    Top Transaction Corridors
                </MudText>
                @if (_topCorridors.Any())
                {
                    <MudSimpleTable Dense="true">
                        <thead>
                            <tr>
                                <th>Corridor</th>
                                <th>Count</th>
                                <th>Volume</th>
                                <th>Avg Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var corridor in _topCorridors)
                            {
                                <tr>
                                    <td>
                                        <MudStack Row="true" AlignItems="AlignItems.Center">
                                            <MudText>@corridor.Source</MudText>
                                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                            <MudText>@corridor.Destination</MudText>
                                        </MudStack>
                                    </td>
                                    <td>@corridor.Count</td>
                                    <td>@corridor.Volume.ToString("N0")</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Color="@(corridor.AvgRisk > 50 ? Color.Error : corridor.AvgRisk > 25 ? Color.Warning : Color.Success)">
                                            @corridor.AvgRisk.ToString("F0")
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No corridor data in this period</MudAlert>
                }
            </MudPaper>
        </MudItem>

        <!-- Compliance Statement -->
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Verified" Color="Color.Success" Class="mr-2" />
                    Compliance Statement
                </MudText>
                <MudText>
                    This report was generated on <strong>@DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss")</strong> UTC 
                    for the period <strong>@_fromDate?.ToString("yyyy-MM-dd")</strong> to <strong>@_toDate?.ToString("yyyy-MM-dd")</strong>.
                </MudText>
                <MudText Class="mt-2">
                    All transactions have been analyzed using the PayGuard AI risk scoring engine in compliance with 
                    Central Bank of Nigeria (CBN) Anti-Money Laundering (AML) guidelines and international FATF recommendations.
                </MudText>
                <MudText Class="mt-2" Color="Color.Primary">
                    <strong>Key Compliance Metrics:</strong>
                    <ul>
                        <li>@_totalTransactions transactions analyzed with @_highRiskCount (@GetPercentage(_highRiskCount)%) flagged for review</li>
                        <li>@_approvedCount transactions approved, @_rejectedCount rejected</li>
                        <li>Average risk score: @_avgRiskScore.ToString("F1")</li>
                        <li>Human-in-the-Loop review coverage: 100% of flagged transactions</li>
                    </ul>
                </MudText>
            </MudPaper>
        </MudItem>
    }
</MudGrid>

@code {
    private DateTime? _fromDate = DateTime.UtcNow.Date.AddDays(-7);
    private DateTime? _toDate = DateTime.UtcNow.Date;
    private bool _reportGenerated = false;

    // Stats
    private int _totalTransactions;
    private int _approvedCount;
    private int _rejectedCount;
    private int _highRiskCount;
    private double _avgRiskScore;

    private List<RiskDistribution> _riskDistribution = new();
    private List<ReviewActivity> _reviewActivity = new();
    private List<TopRiskFactor> _topRiskFactors = new();
    private List<CorridorSummary> _topCorridors = new();
    
    // Chart data
    private double[] _riskChartData = Array.Empty<double>();
    private string[] _riskChartLabels = Array.Empty<string>();
    private List<ChartSeries> _reviewChartSeries = new();
    private string[] _reviewChartLabels = Array.Empty<string>();
    private List<ChartSeries> _factorChartSeries = new();
    private string[] _factorChartLabels = Array.Empty<string>();
    
    private ChartOptions _barOptions = new() { YAxisTicks = 5, MaxNumYAxisTicks = 10 };

    private string GetPercentage(int count)
    {
        if (_totalTransactions == 0) return "0.0";
        return (count * 100.0 / _totalTransactions).ToString("F1");
    }

    protected override async Task OnInitializedAsync()
    {
        await GenerateReport();
    }

    private async Task GenerateReport()
    {
        var from = _fromDate ?? DateTime.UtcNow.Date.AddDays(-30);
        var to = (_toDate ?? DateTime.UtcNow.Date).AddDays(1); // Include full day

        var analyses = await DbContext.RiskAnalyses
            .Include(r => r.Transaction)
            .Include(r => r.RiskFactors)
            .Where(r => r.AnalyzedAt >= from && r.AnalyzedAt < to)
            .ToListAsync();

        _totalTransactions = analyses.Count;
        _approvedCount = analyses.Count(a => a.ReviewStatus == ReviewStatus.Approved || a.ReviewStatus == ReviewStatus.AutoApproved);
        _rejectedCount = analyses.Count(a => a.ReviewStatus == ReviewStatus.Rejected);
        _highRiskCount = analyses.Count(a => a.RiskLevel >= RiskLevel.High);
        _avgRiskScore = analyses.Any() ? analyses.Average(a => a.RiskScore) : 0;

        // Risk distribution
        _riskDistribution = Enum.GetValues<RiskLevel>()
            .Select(level => new RiskDistribution
            {
                Level = level,
                Count = analyses.Count(a => a.RiskLevel == level),
                Percentage = _totalTransactions > 0 
                    ? analyses.Count(a => a.RiskLevel == level) * 100.0 / _totalTransactions 
                    : 0
            })
            .ToList();

        // Review activity
        _reviewActivity = Enum.GetValues<ReviewStatus>()
            .Select(status => new ReviewActivity
            {
                Status = status,
                Count = analyses.Count(a => a.ReviewStatus == status),
                AvgResponseTime = CalculateAvgResponseTime(analyses.Where(a => a.ReviewStatus == status))
            })
            .Where(a => a.Count > 0)
            .ToList();
        
        // Prepare chart data
        _riskChartData = _riskDistribution.Select(d => (double)d.Count).ToArray();
        _riskChartLabels = _riskDistribution.Select(d => d.Level.ToString()).ToArray();
        
        // Review status bar chart
        _reviewChartLabels = _reviewActivity.Select(a => a.Status.ToString()).ToArray();
        _reviewChartSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Transactions", Data = _reviewActivity.Select(a => (double)a.Count).ToArray() }
        };

        // Top risk factors
        var allFactors = analyses.SelectMany(a => a.RiskFactors).ToList();
        _topRiskFactors = allFactors
            .GroupBy(f => f.RuleName)
            .Select(g => new TopRiskFactor
            {
                RuleName = g.Key,
                Category = g.First().Category,
                TriggerCount = g.Count(),
                AvgScoreImpact = (int)g.Average(f => f.ScoreContribution)
            })
            .OrderByDescending(f => f.TriggerCount)
            .Take(6)
            .ToList();
        
        // Factor chart data
        _factorChartLabels = _topRiskFactors.Select(f => f.RuleName.Length > 15 ? f.RuleName[..12] + "..." : f.RuleName).ToArray();
        _factorChartSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Times Triggered", Data = _topRiskFactors.Select(f => (double)f.TriggerCount).ToArray() }
        };
        
        // Top corridors
        _topCorridors = analyses
            .Where(a => a.Transaction != null)
            .GroupBy(a => new { a.Transaction!.SourceCountry, a.Transaction.DestinationCountry })
            .Select(g => new CorridorSummary
            {
                Source = g.Key.SourceCountry,
                Destination = g.Key.DestinationCountry,
                Count = g.Count(),
                Volume = g.Sum(a => a.Transaction!.Amount),
                AvgRisk = g.Average(a => a.RiskScore)
            })
            .OrderByDescending(c => c.Count)
            .Take(5)
            .ToList();

        _reportGenerated = true;
    }

    private string CalculateAvgResponseTime(IEnumerable<RiskAnalysis> analyses)
    {
        var reviewed = analyses.Where(a => a.ReviewedAt.HasValue).ToList();
        if (!reviewed.Any()) return "N/A";
        
        var avgMinutes = reviewed.Average(a => (a.ReviewedAt!.Value - a.AnalyzedAt).TotalMinutes);
        return avgMinutes < 60 ? $"{avgMinutes:F0} min" : $"{avgMinutes / 60:F1} hrs";
    }

    private void ExportReport()
    {
        Snackbar.Add("CSV export coming soon â€” report data is available via the audit log.", Severity.Info);
    }

    private Color GetRiskColor(RiskLevel level) => level switch
    {
        RiskLevel.Low => Color.Success,
        RiskLevel.Medium => Color.Warning,
        RiskLevel.High => Color.Error,
        RiskLevel.Critical => Color.Dark,
        _ => Color.Default
    };

    private Color GetStatusColor(ReviewStatus status) => status switch
    {
        ReviewStatus.Pending => Color.Warning,
        ReviewStatus.Approved or ReviewStatus.AutoApproved => Color.Success,
        ReviewStatus.Rejected => Color.Error,
        ReviewStatus.Escalated => Color.Info,
        _ => Color.Default
    };

    private Color GetCategoryColor(string category) => category switch
    {
        "Amount" => Color.Primary,
        "Velocity" => Color.Secondary,
        "Geography" => Color.Error,
        "Pattern" => Color.Info,
        _ => Color.Default
    };

    private class RiskDistribution
    {
        public RiskLevel Level { get; set; }
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    private class ReviewActivity
    {
        public ReviewStatus Status { get; set; }
        public int Count { get; set; }
        public string AvgResponseTime { get; set; } = "";
    }

    private class TopRiskFactor
    {
        public string RuleName { get; set; } = "";
        public string Category { get; set; } = "";
        public int TriggerCount { get; set; }
        public int AvgScoreImpact { get; set; }
    }
    
    private class CorridorSummary
    {
        public string Source { get; set; } = "";
        public string Destination { get; set; } = "";
        public int Count { get; set; }
        public decimal Volume { get; set; }
        public double AvgRisk { get; set; }
    }
}
