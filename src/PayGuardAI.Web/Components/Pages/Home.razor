@page "/"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ITransactionService TransactionService
@inject IReviewService ReviewService
@inject IAdminService AdminService
@inject IFraudSavingsService FraudSavingsService
@inject ITenantContext TenantContext
@inject NavigationManager NavigationManager
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using PayGuardAI.Web.Hubs

<PageTitle>Dashboard - PayGuard AI</PageTitle>

@if (TenantContext.IsDisabled)
{
    <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4" Icon="@Icons.Material.Filled.PauseCircleFilled">
        <strong>Service Suspended</strong> — Your organization's PayGuard transaction processing is currently disabled.
        New transactions will not be analyzed. Please contact your platform administrator to re-enable service.
    </MudAlert>
}

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
    Risk Monitoring Dashboard
</MudText>

@if (_loadError)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudText>Failed to load dashboard: @_errorMessage</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small" OnClick="RetryLoadAsync">
                Retry
            </MudButton>
        </MudStack>
    </MudAlert>
}
else if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <!-- 🛡 Fraud Saved Hero Widget -->
    <MudPaper Class="pa-5 mb-4" Elevation="3"
              Style="background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #388e3c 100%); color: white; border-radius: 12px;">
        <MudGrid>
            <MudItem xs="12" md="7">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Large" Style="font-size: 3rem; opacity: 0.9;" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Style="opacity: 0.85; letter-spacing: 1px; text-transform: uppercase;">
                            Fraud Prevented This Month
                        </MudText>
                        <MudText Typo="Typo.h3" Style="font-weight: 700; letter-spacing: -1px;">
                            @FormatCurrency(_savings.SavedThisMonth) @_savings.CurrencyCode
                        </MudText>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-1">
                            @if (_savings.TrendPercent > 0)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Style="opacity: 0.9;" />
                                <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                    +@_savings.TrendPercent% vs last month
                                </MudText>
                            }
                            else if (_savings.TrendPercent < 0)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Small" Style="opacity: 0.9;" />
                                <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                    @_savings.TrendPercent% vs last month
                                </MudText>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Size="Size.Small" Style="opacity: 0.9;" />
                                <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                    No change vs last month
                                </MudText>
                            }
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudItem>
            <MudItem xs="12" md="5">
                <MudStack Row="true" Justify="Justify.SpaceAround" Style="height: 100%; flex-wrap: wrap; gap: 12px;">
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudText Typo="Typo.h4" Style="font-weight: 600;">@_savings.BlockedCountThisMonth</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.85;">Blocked This Month</MudText>
                    </MudStack>
                    <MudDivider Vertical="true" FlexItem="true" Style="border-color: rgba(255,255,255,0.3);" />
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudText Typo="Typo.h4" Style="font-weight: 600;">@FormatCurrency(_savings.SavedThisWeek)</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.85;">Saved This Week</MudText>
                    </MudStack>
                    <MudDivider Vertical="true" FlexItem="true" Style="border-color: rgba(255,255,255,0.3);" />
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudText Typo="Typo.h4" Style="font-weight: 600;">@FormatCurrency(_savings.SavedAllTime)</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.85;">All-Time Saved</MudText>
                    </MudStack>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Stats Cards -->
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" Color="Color.Primary" Size="Size.Large" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Primary">Total Transactions</MudText>
                        <MudText Typo="Typo.h4">@_stats.TotalTransactions</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.PendingActions" Color="Color.Warning" Size="Size.Large" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Warning">Pending Reviews</MudText>
                        <MudText Typo="Typo.h4">@_stats.PendingReviews</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Large" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Error">High Risk</MudText>
                        <MudText Typo="Typo.h4">@_stats.HighRiskCount</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Info" Size="Size.Large" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Info">Avg Risk Score</MudText>
                        <MudText Typo="Typo.h4">@_stats.AverageRiskScore.ToString("F1")</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Today's Activity -->
    <MudGrid Class="mt-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Today's Activity</MudText>
                <MudStack Row="true" Justify="Justify.SpaceAround" Style="flex-wrap: wrap; gap: 16px;">
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                        <MudText Typo="Typo.h5">@_stats.ApprovedToday</MudText>
                        <MudText Typo="Typo.caption">Approved</MudText>
                    </MudStack>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Large" />
                        <MudText Typo="Typo.h5">@_stats.RejectedToday</MudText>
                        <MudText Typo="Typo.caption">Rejected</MudText>
                    </MudStack>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.h5">@_stats.TotalVolumeToday.ToString("N0") USD</MudText>
                        <MudText Typo="Typo.caption">Volume</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Actions</MudText>
                <MudStack Row="true" Spacing="3" Style="flex-wrap: wrap; gap: 8px;">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mobile-action-btn"
                               StartIcon="@Icons.Material.Filled.RateReview" Href="/reviews">
                        Review Queue (@_stats.PendingReviews)
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="mobile-action-btn"
                               StartIcon="@Icons.Material.Filled.Assessment" Href="/reports">
                        Generate Report
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Recent High-Risk Transactions -->
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3" Style="flex-wrap: wrap; gap: 8px;">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Class="mr-2" />
                Recent High-Risk Transactions
            </MudText>
            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/transactions">View All</MudButton>
        </MudStack>

        @if (_recentHighRisk.Any())
        {
            <MudTable Items="@_recentHighRisk" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh>Corridor</MudTh>
                    <MudTh>Risk Score</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Time</MudTh>
                    <MudTh>Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@(context.ExternalId.Length > 8 ? context.ExternalId[..8] + "..." : context.ExternalId)</MudTd>
                    <MudTd DataLabel="Amount">@context.Amount.ToString("N2") @context.SourceCurrency</MudTd>
                    <MudTd DataLabel="Corridor">@context.SourceCountry → @context.DestinationCountry</MudTd>
                    <MudTd DataLabel="Risk Score">
                        <MudChip T="string" Size="Size.Small" Color="@GetRiskColor(context.RiskAnalysis?.RiskLevel)">
                            @(context.RiskAnalysis?.RiskScore ?? 0)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.RiskAnalysis?.ReviewStatus)">
                            @(context.RiskAnalysis?.ReviewStatus.ToString() ?? "N/A")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Time">@context.ReceivedAt.ToString("HH:mm:ss")</MudTd>
                    <MudTd DataLabel="">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                       Size="Size.Small" Color="Color.Primary"
                                       OnClick="@(() => NavigationManager.NavigateTo($"/transactions/{context.Id}?returnTo=/"))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Info">No high-risk transactions detected recently.</MudAlert>
        }
    </MudPaper>
}

@code {
    private bool _loading = true;
    private bool _loadError = false;
    private string _errorMessage = "";
    private DashboardStats _stats = new();
    private FraudSavingsSummary _savings = new();
    private List<Transaction> _recentHighRisk = new();
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        // ── First-time user redirect ──
        try
        {
            var tenantId = TenantContext.TenantId;
            if (!string.IsNullOrEmpty(tenantId))
            {
                var settings = await AdminService.GetOrCreateSettingsAsync(tenantId);
                if (!settings.OnboardingCompleted && settings.OrganizationName == "My Organization")
                {
                    NavigationManager.NavigateTo($"/onboarding?tenantId={tenantId}");
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            // If onboarding check fails, continue to dashboard normally
            Console.WriteLine($"Onboarding check skipped: {ex.Message}");
        }

        try
        {
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            _loadError = true;
            _errorMessage = ex.Message;
            _loading = false;
            return;
        }
        
        // Setup SignalR after data loads successfully
        try
        {
            await SetupSignalR();
        }
        catch (Exception ex)
        {
            // SignalR failure shouldn't block the dashboard
            Console.WriteLine($"SignalR setup failed: {ex.Message}");
        }
    }

    private async Task SetupSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/transactions"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<TransactionNotification>("NewTransaction", async (_) =>
        {
            // Reload dashboard data when a new transaction arrives (no loading spinner)
            await RefreshDataAsync();
        });

        await _hubConnection.StartAsync();

        // Join tenant-specific group so we only get our own org's updates
        var tenantId = TenantContext.TenantId;
        if (!string.IsNullOrEmpty(tenantId))
        {
            await _hubConnection.InvokeAsync("JoinTenantGroup", tenantId);
        }
    }

    private async Task RetryLoadAsync()
    {
        _loadError = false;
        _errorMessage = "";
        await OnInitializedAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshDataAsync()
    {
        try
        {
            _stats = await TransactionService.GetDashboardStatsAsync();

            try { _savings = await FraudSavingsService.GetSavingsSummaryAsync(); }
            catch { /* savings refresh failure is non-fatal */ }
            
            var allTransactions = await TransactionService.GetTransactionsAsync(
                pageNumber: 1, 
                pageSize: 20);
            _recentHighRisk = allTransactions
                .Where(t => t.RiskAnalysis != null && t.RiskAnalysis.RiskLevel >= RiskLevel.High)
                .Take(5)
                .ToList();
        }
        catch
        {
            // Silently handle refresh errors - dashboard will update on next cycle
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadDataAsync()
    {
        _loading = true;
        _stats = await TransactionService.GetDashboardStatsAsync();

        // Load fraud savings (non-fatal — dashboard still works if this fails)
        try { _savings = await FraudSavingsService.GetSavingsSummaryAsync(); }
        catch { _savings = new FraudSavingsSummary(); }
        
        // Get both High and Critical risk transactions
        var allTransactions = await TransactionService.GetTransactionsAsync(
            pageNumber: 1, 
            pageSize: 20);
        _recentHighRisk = allTransactions
            .Where(t => t.RiskAnalysis != null && t.RiskAnalysis.RiskLevel >= RiskLevel.High)
            .Take(5)
            .ToList();
        
        _loading = false;
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private Color GetRiskColor(RiskLevel? level) => level switch
    {
        RiskLevel.Low => Color.Success,
        RiskLevel.Medium => Color.Warning,
        RiskLevel.High => Color.Error,
        RiskLevel.Critical => Color.Dark,
        _ => Color.Default
    };

    private Color GetStatusColor(ReviewStatus? status) => status switch
    {
        ReviewStatus.Pending => Color.Warning,
        ReviewStatus.Approved or ReviewStatus.AutoApproved => Color.Success,
        ReviewStatus.Rejected => Color.Error,
        ReviewStatus.Escalated => Color.Info,
        _ => Color.Default
    };

    private static string FormatCurrency(decimal amount) => amount switch
    {
        >= 1_000_000 => $"${amount / 1_000_000:N1}M",
        >= 1_000 => $"${amount / 1_000:N1}K",
        _ => $"${amount:N0}"
    };
}
