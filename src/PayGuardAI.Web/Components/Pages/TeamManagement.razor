@page "/admin/team"
@using Microsoft.AspNetCore.Authorization
@using PayGuardAI.Core.Entities
@using PayGuardAI.Core.Services
@attribute [Authorize(Policy = "CanManageTeam")]
@inject PayGuardAI.Core.Services.IAdminService AdminService
@inject IRbacService RbacService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject PayGuardAI.Web.Services.CurrentUserService CurrentUser
@inject PayGuardAI.Core.Services.ITenantContext TenantContext
@inject IConfiguration Configuration
@inject IPlanFeatureService PlanFeatures

<PageTitle>Team Management — PayGuard AI</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4" Style="flex-wrap: wrap; gap: 12px;">
    <MudText Typo="Typo.h4">
        <MudIcon Icon="@Icons.Material.Filled.Group" Class="mr-2" />
        Team Management
    </MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.PersonAdd"
               OnClick="OpenInviteDialog">
        Invite Member
    </MudButton>
</MudStack>

@if (!_emailEnabled)
{
    <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true" Variant="Variant.Outlined">
        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
        Email notifications are not configured. Inviting a member adds them to your team but <strong>no invitation email will be sent</strong>.
        Share login credentials with new members directly.
    </MudAlert>
}

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else
{
    <MudTable Items="_members" Hover="true" Elevation="2" Dense="true" Breakpoint="Breakpoint.Sm">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Role</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Last Login</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudAvatar Size="Size.Small" Color="Color.Primary">
                        @(context.DisplayName.Length > 0 ? context.DisplayName[0].ToString().ToUpper() : "?")
                    </MudAvatar>
                    @context.DisplayName
                </MudStack>
            </MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Role">
                <MudSelect T="string" Value="@context.Role" Dense="true" Margin="Margin.Dense"
                           Variant="Variant.Text"
                           ValueChanged="@(async (string role) => await ChangeRole(context, role))">
                    @foreach (var role in _availableRoles)
                    {
                        <MudSelectItem Value="@role.Name">@role.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                    @context.Status
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Last Login">
                @(context.LastLoginAt?.ToString("MMM dd, yyyy HH:mm") ?? "Never")
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error" Size="Size.Small"
                               OnClick="@(() => RemoveMember(context))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                No team members yet. Invite your first member!
            </MudText>
        </NoRecordsContent>
    </MudTable>
}

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Class="mt-4">@_error</MudAlert>
}

@code {
    private List<TeamMember> _members = [];
    private List<CustomRole> _availableRoles = [];
    private bool _loading = true;
    private string _error = string.Empty;
    private bool _emailEnabled;
    private int _maxTeamMembers = int.MaxValue;

    protected override async Task OnInitializedAsync()
    {
        var resendKey = Configuration["Email:ResendApiKey"] ?? Configuration["Email:SmtpPassword"] ?? "";
        _emailEnabled = !string.IsNullOrEmpty(resendKey) && resendKey.StartsWith("re_");
        var billingEnabled = Configuration.GetValue<bool>("FeatureFlags:BillingEnabled");
        if (billingEnabled)
        {
            var plan = await PlanFeatures.GetCurrentPlanAsync(TenantContext.TenantId);
            _maxTeamMembers = PlanFeatures.GetMaxTeamMembers(plan);
        }
        await LoadMembers();
    }

    private async Task LoadMembers()
    {
        _loading = true;
        try
        {
            _members = await AdminService.GetTeamMembersAsync(TenantContext.TenantId);
            _availableRoles = await RbacService.GetRolesAsync(TenantContext.TenantId);
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    private async Task OpenInviteDialog()
    {
        if (_members.Count >= _maxTeamMembers)
        {
            Snackbar.Add(
                $"You've reached the {_maxTeamMembers}-member limit on your current plan. Upgrade to add more team members.",
                Severity.Warning);
            return;
        }
        var parameters = new DialogParameters<InviteMemberDialog>
        {
            { x => x.AvailableRoles, _availableRoles }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<InviteMemberDialog>("Invite Team Member", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: TeamMember newMember })
        {
            try
            {
                var (_, emailSent) = await AdminService.InviteTeamMemberAsync(TenantContext.TenantId, newMember.Email, newMember.DisplayName, newMember.Role);
                if (emailSent)
                {
                    Snackbar.Add($"Invitation sent to {newMember.Email}! They'll receive a sign-in link.", Severity.Success);
                }
                else if (_emailEnabled)
                {
                    Snackbar.Add($"Team member added, but the invite email failed to send. They can request a magic link from the login page.", Severity.Warning);
                }
                else
                {
                    Snackbar.Add($"Team member {newMember.DisplayName} added. Email not configured — share the login URL with them directly.", Severity.Info);
                }
                await LoadMembers();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Failed to add team member: {ex}");
                Snackbar.Add("Failed to add team member. Please try again.", Severity.Error);
            }
        }
    }

    private async Task ChangeRole(TeamMember member, string newRole)
    {
        try
        {
            await RbacService.AssignRoleAsync(member.Id, newRole, CurrentUser.UserName);
            member.Role = newRole;
            Snackbar.Add($"Updated {member.DisplayName}'s role to {newRole}", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to change role: {ex}");
            Snackbar.Add("Failed to update role. Please try again.", Severity.Error);
        }
    }

    private async Task RemoveMember(TeamMember member)
    {
        // Prevent self-deletion in the UI as well
        if (string.Equals(member.Email, CurrentUser.UserName, StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add("You cannot remove yourself. Ask another admin to remove your account.", Severity.Warning);
            return;
        }

        var confirmed = await DialogService.ShowMessageBox(
            "Remove Team Member",
            $"Are you sure you want to remove {member.DisplayName} ({member.Email})?",
            yesText: "Remove", cancelText: "Cancel");
        if (confirmed == true)
        {
            try
            {
                await AdminService.RemoveTeamMemberAsync(member.Id, CurrentUser.UserName);
                Snackbar.Add($"Removed {member.DisplayName}", Severity.Info);
                await LoadMembers();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Failed to remove team member: {ex}");
                Snackbar.Add("Failed to remove team member. Please try again.", Severity.Error);
            }
        }
    }

    private static Color GetStatusColor(string status) => status switch
    {
        "active" => Color.Success,
        "invited" => Color.Info,
        "disabled" => Color.Default,
        _ => Color.Default
    };
}
